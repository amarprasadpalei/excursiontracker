<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Excursion Tracker</title>
    
    <!-- Google Fonts: Inter (Premium Look) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">

    <!-- Tailwind CSS (with Dark Mode enabled via class) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                    colors: {
                        glass: {
                            light: 'rgba(255, 255, 255, 0.7)',
                            dark: 'rgba(15, 23, 42, 0.7)',
                        }
                    },
                    animation: {
                        'blob': 'blob 10s infinite',
                        'enter': 'enter 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'enter-delayed': 'enter 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards 0.2s',
                        'slide-up': 'slide-up 0.5s ease-out forwards',
                        'pulse-glow': 'pulse-glow 2s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        blob: {
                            '0%': { transform: 'translate(0px, 0px) scale(1)' },
                            '33%': { transform: 'translate(30px, -50px) scale(1.1)' },
                            '66%': { transform: 'translate(-20px, 20px) scale(0.9)' },
                            '100%': { transform: 'translate(0px, 0px) scale(1)' },
                        },
                        enter: {
                            '0%': { opacity: '0', transform: 'translateY(20px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                        'slide-up': {
                            '0%': { transform: 'translateY(100%)' },
                            '100%': { transform: 'translateY(0)' },
                        },
                        'pulse-glow': {
                            '0%, 100%': { opacity: '1', boxShadow: '0 0 0 0px rgba(16, 185, 129, 0.7)' },
                            '50%': { opacity: '.5', boxShadow: '0 0 0 10px rgba(16, 185, 129, 0)' },
                        }
                    }
                }
            }
        }
    </script>
    
    <!-- PDF Generation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Import Maps -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.344.0",
            "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js"
        }
    }
    </script>

    <style>
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        body { -webkit-tap-highlight-color: transparent; }
        
        .glass-panel {
            background: rgba(255, 255, 255, 0.65);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }
        .dark .glass-panel {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        /* Premium Gradient Background */
        .bg-mesh-premium {
            background-color: #0f172a;
            background-image: 
                radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), 
                radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%), 
                radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%);
        }
        
        * { transition-property: background-color, border-color, color, fill, stroke, transform, opacity, box-shadow; transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); transition-duration: 200ms; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        
        import { 
            Bus, MapPin, CheckCircle2, XCircle, UserPlus, Users, Filter, 
            Trash2, AlertTriangle, RotateCcw, Loader2, Phone, Shield, 
            GraduationCap, LogOut, Settings as SettingsIcon, UserCheck, Edit3, Save,
            Search, Megaphone, Bell, X, BarChart3, Lock, ArrowLeft, Key,
            FileText, Clipboard, AlertOctagon, StickyNote, Download, Printer,
            RefreshCw, Check, FileSpreadsheet, KeyRound, Smartphone, Moon, Sun, Clock,
            Calendar, Plus, ChevronRight, History
        } from 'lucide-react';

        import { initializeApp } from "firebase/app";
        import { 
            getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, 
            onSnapshot, query, setDoc, writeBatch, orderBy
        } from "firebase/firestore";
        import { 
            getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken 
        } from "firebase/auth";

        // --- Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyCJ-FXK3QhjAjR7GgiBZAFfdTKMLm_zjSc",
            authDomain: "excursion-management.firebaseapp.com",
            projectId: "excursion-management",
            storageBucket: "excursion-management.firebasestorage.app",
            messagingSenderId: "876876669096",
            appId: "1:876876669096:web:c7ab2b68141d2850b8629d"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'excursion-manager-production';

        // --- Toast Component ---
        const Toast = ({ message, type, onClose }) => {
            useEffect(() => {
                const timer = setTimeout(onClose, 3000);
                return () => clearTimeout(timer);
            }, [onClose]);

            return (
                <div className={`fixed top-6 left-1/2 -translate-x-1/2 z-[100] flex items-center gap-3 px-6 py-3 rounded-full shadow-2xl animate-in slide-in-from-top-4 fade-in duration-300 border backdrop-blur-md ${
                type === 'error' 
                    ? 'bg-rose-500/90 text-white border-rose-400' 
                    : 'bg-slate-800/90 text-white border-slate-600 dark:bg-white/90 dark:text-slate-900'
                }`}>
                {type === 'success' ? <CheckCircle2 className="w-5 h-5 text-emerald-400 dark:text-emerald-600" /> : null}
                {type === 'error' ? <AlertTriangle className="w-5 h-5 text-white" /> : null}
                <span className="font-bold text-sm tracking-wide">{message}</span>
                </div>
            );
        };

        // --- Helper: Format Timestamp ---
        const formatTime = (isoString) => {
            if (!isoString) return 'Not recorded';
            return new Date(isoString).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        };

        function App() {
            // --- State ---
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [authError, setAuthError] = useState(null);
            const [role, setRole] = useState(null);
            const [currentTeacherProfile, setCurrentTeacherProfile] = useState(null);
            const [darkMode, setDarkMode] = useState(false);

            const [students, setStudents] = useState([]);
            const [teachers, setTeachers] = useState([]);
            const [schedule, setSchedule] = useState([]); 
            const [notifications, setNotifications] = useState([]); // NEW: Notifications State
            const [globalSettings, setGlobalSettings] = useState({ 
                locationName: 'Starting Point', 
                announcement: '', 
                sos: false,
                adminPasscode: '1234'
            });
            
            const [activeTab, setActiveTab] = useState('monitor'); 
            const [showAddModal, setShowAddModal] = useState(false);
            const [viewMode, setViewMode] = useState('all'); 
            const [busFilter, setBusFilter] = useState('all'); 
            const [isEditingLocation, setIsEditingLocation] = useState(false);
            const [tempLocationName, setTempLocationName] = useState('');
            const [searchQuery, setSearchQuery] = useState('');
            const [toast, setToast] = useState(null);
            
            const [showBroadcastModal, setShowBroadcastModal] = useState(false);
            const [broadcastMsg, setBroadcastMsg] = useState('');
            
            const [editingStudent, setEditingStudent] = useState(null); 
            const [noteStudent, setNoteStudent] = useState(null); 
            const [viewProfile, setViewProfile] = useState(null);

            const [studentForm, setStudentForm] = useState({ 
                name: '', class: '', contact: '', personalContact: '', bus: '', assignedTeacherId: '', note: '' 
            });
            const [teacherForm, setTeacherForm] = useState({ name: '', password: '' });
            const [scheduleForm, setScheduleForm] = useState({ time: '', title: '' });

            const [loginPasscode, setLoginPasscode] = useState('');
            const [loginError, setLoginError] = useState('');
            const [newAdminPasscode, setNewAdminPasscode] = useState('');
            const [selectedTeacherId, setSelectedTeacherId] = useState(null);
            const [teacherLoginPassword, setTeacherLoginPassword] = useState('');

            // --- Effects ---
            useEffect(() => {
                if (darkMode) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
            }, [darkMode]);

            useEffect(() => {
                const initAuth = async () => {
                    try {
                        await signInAnonymously(auth);
                    } catch (error) {
                        console.error("Auth Failed", error);
                        if (error.code === 'auth/admin-restricted-operation' || error.code === 'auth/operation-not-allowed') {
                            setAuthError("Configuration Error: 'Anonymous' sign-in is disabled in your Firebase Console.");
                        } else {
                            setAuthError(error.message);
                        }
                        setLoading(false); 
                    }
                };
                initAuth();
                const unsubscribe = onAuthStateChanged(auth, (u) => {
                    if (u) {
                        setUser(u);
                        setLoading(false); 
                        setAuthError(null);
                    }
                });
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (!user) return;

                const qStudents = query(collection(db, 'artifacts', appId, 'public', 'data', 'students'));
                const unsubStudents = onSnapshot(qStudents, (snap) => {
                    const list = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    list.sort((a, b) => (a.onBus === b.onBus ? 0 : a.onBus ? 1 : -1) || a.class.localeCompare(b.class));
                    setStudents(list);
                });

                const qTeachers = query(collection(db, 'artifacts', appId, 'public', 'data', 'teachers'));
                const unsubTeachers = onSnapshot(qTeachers, (snap) => {
                    setTeachers(snap.docs.map(d => ({ id: d.id, ...d.data() })));
                });

                const qSchedule = query(collection(db, 'artifacts', appId, 'public', 'data', 'schedule'));
                const unsubSchedule = onSnapshot(qSchedule, (snap) => {
                    const list = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    list.sort((a,b) => a.time.localeCompare(b.time)); 
                    setSchedule(list);
                });

                // NEW: Notifications Listener
                const qNotifs = query(collection(db, 'artifacts', appId, 'public', 'data', 'notifications'), orderBy('createdAt', 'desc'));
                const unsubNotifs = onSnapshot(qNotifs, (snap) => {
                    setNotifications(snap.docs.map(d => ({ id: d.id, ...d.data() })));
                });

                const settingsRef = doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'global');
                const unsubSettings = onSnapshot(settingsRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        setGlobalSettings(data);
                        setTempLocationName(data.locationName || 'School Campus');
                    } else {
                        setDoc(settingsRef, { locationName: 'School Campus', announcement: '', sos: false, adminPasscode: '1234' });
                    }
                });

                return () => { unsubStudents(); unsubTeachers(); unsubSchedule(); unsubNotifs(); unsubSettings(); };
            }, [user]);

            const showToast = (message, type = 'success') => { setToast({ message, type }); };

            // --- Handlers ---
            const handleAdminLogin = (e) => {
                e.preventDefault();
                const correctPasscode = globalSettings.adminPasscode || '1234';
                if (loginPasscode === correctPasscode) {
                    setRole('admin'); setActiveTab('monitor'); setLoginError(''); setLoginPasscode(''); showToast("Welcome back, Admin");
                } else {
                    setLoginError('Incorrect passcode');
                }
            };

            const submitTeacherLogin = (e) => {
                e.preventDefault();
                const teacher = teachers.find(t => t.id === selectedTeacherId);
                if (teacher && teacher.password === teacherLoginPassword) {
                    setCurrentTeacherProfile(teacher); setRole('teacher'); setActiveTab('monitor'); setSelectedTeacherId(null); setTeacherLoginPassword(''); setLoginError(''); showToast(`Welcome, ${teacher.name}`);
                } else {
                    setLoginError('Incorrect password');
                }
            };

            const logout = () => {
                setRole(null); setCurrentTeacherProfile(null); setLoginPasscode(''); setSelectedTeacherId(null); setTeacherLoginPassword(''); setSearchQuery(''); setLoginError('');
            };

            // --- Database Operations ---
            const toggleStudentStatus = async (student) => {
                if (role === 'teacher' && student.assignedTeacherId !== currentTeacherProfile?.id) { showToast("You can only mark your own students", "error"); return; }
                const ref = doc(db, 'artifacts', appId, 'public', 'data', 'students', student.id);
                await updateDoc(ref, { onBus: !student.onBus, lastStatusChange: new Date().toISOString() });
            };

            const markBatch = async (targetState) => {
                if (!window.confirm(targetState ? "Mark ALL assigned students as ON BUS?" : "Mark ALL assigned students as OFF BUS?")) return;
                const studentsToUpdate = filteredStudents;
                const timestamp = new Date().toISOString();
                const promises = studentsToUpdate.map(s => {
                    if (s.onBus !== targetState) {
                        return updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'students', s.id), { onBus: targetState, lastStatusChange: timestamp });
                    }
                    return Promise.resolve();
                });
                await Promise.all(promises);
                showToast(targetState ? "Batch marked ON bus" : "Batch marked OFF bus");
            };

            const addStudent = async (e) => {
                e.preventDefault();
                if (!studentForm.name || !studentForm.class) return;
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'students'), { ...studentForm, onBus: true, lastStatusChange: new Date().toISOString(), createdAt: Date.now() });
                setStudentForm({ name: '', class: '', contact: '', personalContact: '', bus: '', assignedTeacherId: '', note: '' });
                setShowAddModal(false); showToast("Student added");
            };

            const updateStudent = async (e) => {
                e.preventDefault();
                if (!editingStudent) return;
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'students', editingStudent.id), {
                    name: editingStudent.name, class: editingStudent.class, contact: editingStudent.contact, 
                    personalContact: editingStudent.personalContact, bus: editingStudent.bus,
                    assignedTeacherId: editingStudent.assignedTeacherId
                });
                setEditingStudent(null); showToast("Student updated");
            };

            const saveNote = async () => {
                if (!noteStudent) return;
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'students', noteStudent.id), { note: noteStudent.note });
                setNoteStudent(null); showToast("Note saved");
            };

            const addScheduleItem = async (e) => {
                e.preventDefault();
                if (!scheduleForm.time || !scheduleForm.title) return;
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'schedule'), {
                    ...scheduleForm, createdAt: Date.now()
                });
                setScheduleForm({ time: '', title: '' });
                showToast("Event added");
            };

            const deleteScheduleItem = async (id) => {
                if (confirm("Remove event?")) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'schedule', id));
            };

            const deleteStudent = async (id) => {
                if (window.confirm("Delete permanently?")) {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'students', id)); showToast("Student deleted");
                }
            };

            const addTeacher = async (e) => {
                e.preventDefault();
                if (!teacherForm.name.trim()) return;
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'teachers'), { ...teacherForm, createdAt: Date.now() });
                setTeacherForm({ name: '', password: '' }); showToast("Teacher added");
            };

            const deleteTeacher = async (id) => {
                if (window.confirm("Delete teacher?")) {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'teachers', id)); showToast("Teacher deleted");
                }
            };

            const updateAdminPasscode = async (e) => {
                e.preventDefault();
                if (!newAdminPasscode) return;
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'global'), { adminPasscode: newAdminPasscode.trim() }, { merge: true });
                setNewAdminPasscode(''); showToast("Passcode updated");
            };

            const updateLocationName = async () => {
                if (!tempLocationName) return;
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'global'), { locationName: tempLocationName }, { merge: true });
                setIsEditingLocation(false); showToast("Location updated");
            };

            const toggleSOS = async () => {
                const newState = !globalSettings.sos;
                if (newState && !confirm("Activate SOS?")) return;
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'global'), { sos: newState }, { merge: true });
            };

            const sendBroadcast = async () => {
                if (!broadcastMsg) return;
                const timestamp = Date.now();
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'global'), { announcement: broadcastMsg }, { merge: true });
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'notifications'), {
                    message: broadcastMsg,
                    createdAt: timestamp,
                    sender: 'Admin'
                });
                setShowBroadcastModal(false); setBroadcastMsg(''); showToast("Broadcast sent");
            };

            const clearBroadcast = async () => {
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'global'), { announcement: '' }, { merge: true });
                showToast("Broadcast cleared");
            };

            const resetAllStatuses = async () => {
                if (!window.confirm("Reset ALL students to 'On Bus'?")) return;
                const batch = writeBatch(db);
                students.forEach(s => {
                    batch.update(doc(db, 'artifacts', appId, 'public', 'data', 'students', s.id), { onBus: true, lastStatusChange: new Date().toISOString() });
                });
                await batch.commit();
                showToast("Trip reset successful");
            };

            const handlePrint = () => {
                if (!window.jspdf) { showToast("PDF Lib Loading...", "error"); return; }
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                doc.setFillColor(79, 70, 229); doc.rect(0, 0, 210, 30, 'F');
                doc.setTextColor(255, 255, 255); doc.setFontSize(22); doc.text("Excursion Report", 14, 18);
                doc.setFontSize(10); doc.text(`Generated: ${new Date().toLocaleString()}`, 14, 25);
                
                doc.setTextColor(50); doc.setFontSize(12); doc.text(`Location: ${globalSettings.locationName}`, 14, 40);
                
                const tableColumn = ["Name", "Class", "Bus", "Teacher", "Status", "Note"];
                const tableRows = [];
                students.forEach(student => {
                    const teacherName = teachers.find(t => t.id === student.assignedTeacherId)?.name || 'Unassigned';
                    tableRows.push([student.name, student.class, student.bus || '-', teacherName, student.onBus ? "ON BUS" : "MISSING", student.note || '']);
                });

                doc.autoTable({ head: [tableColumn], body: tableRows, startY: 50, theme: 'grid' });
                doc.save(`Excursion_Report.pdf`);
                showToast("PDF Downloaded");
            };

            const copyReport = () => {
                const missing = students.filter(s => !s.onBus);
                let text = `*Excursion Report*\n${globalSettings.locationName}\nTotal: ${students.length} | Missing: ${missing.length}\n`;
                if(missing.length) text += `\n*Missing:*\n` + missing.map(s => `- ${s.name}`).join('\n');
                else text += `\nâœ… All Accounted For`;
                navigator.clipboard.writeText(text);
                showToast("Copied to clipboard");
            };

            // --- Logic ---
            let filteredStudents = students;
            if (role === 'teacher' && currentTeacherProfile) {
                filteredStudents = students.filter(s => s.assignedTeacherId === currentTeacherProfile.id);
            }
            if (viewMode === 'missing') filteredStudents = filteredStudents.filter(s => !s.onBus);
            if (busFilter !== 'all') filteredStudents = filteredStudents.filter(s => s.bus === busFilter);
            if (searchQuery) filteredStudents = filteredStudents.filter(s => s.name.toLowerCase().includes(searchQuery.toLowerCase()));

            const studentsOnBusCount = filteredStudents.filter(s => s.onBus).length;
            const totalCount = filteredStudents.length;
            const missingCount = totalCount - studentsOnBusCount;
            const allAboard = missingCount === 0 && totalCount > 0;
            const progress = totalCount > 0 ? (studentsOnBusCount / totalCount) * 100 : 0;

            const teacherStats = teachers.map(t => {
                const assigned = students.filter(s => s.assignedTeacherId === t.id);
                const missing = assigned.filter(s => !s.onBus).length;
                return { ...t, assignedCount: assigned.length, missingCount: missing };
            });

            // Get unique buses for filter
            const uniqueBuses = [...new Set(students.map(s => s.bus).filter(Boolean))].sort();

            if (authError) return <div className="min-h-screen flex items-center justify-center p-4 text-center bg-slate-900 text-white"><div className="bg-rose-900/50 p-8 rounded-2xl border border-rose-500/30 backdrop-blur-xl shadow-2xl max-w-md w-full"><AlertTriangle className="w-16 h-16 text-rose-500 mx-auto mb-4" /><h2 className="text-2xl font-bold mb-2">Access Issue</h2><p className="text-rose-200 mb-4">{authError}</p><button onClick={()=>window.location.reload()} className="w-full py-3 bg-rose-600 rounded-xl font-bold hover:bg-rose-700">Retry</button></div></div>;
            
            if (loading) return <div className="min-h-screen flex flex-col items-center justify-center bg-slate-900 text-white"><div className="relative w-20 h-20 mb-6"><div className="absolute inset-0 bg-indigo-500/30 rounded-full animate-ping"></div><div className="relative bg-slate-800 p-5 rounded-full shadow-xl border border-white/10"><Bus className="w-10 h-10 text-indigo-400 animate-pulse" /></div></div><p className="text-slate-400 font-medium tracking-widest uppercase text-sm animate-pulse">Initializing System...</p></div>;

            // --- PREMIUM LANDING PAGE (FULL SCREEN) ---
            if (!role) {
                return (
                    <div className="min-h-screen w-full relative overflow-hidden bg-slate-950 text-white flex flex-col md:flex-row font-sans">
                        {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}
                        
                        {/* Background Effects */}
                        <div className="absolute inset-0 bg-mesh-premium opacity-80"></div>
                        <div className="absolute top-[-10%] left-[-10%] w-[60%] h-[60%] rounded-full bg-indigo-600/20 blur-[120px] animate-blob"></div>
                        <div className="absolute bottom-[-10%] right-[-10%] w-[60%] h-[60%] rounded-full bg-violet-600/20 blur-[120px] animate-blob" style={{ animationDelay: '2s' }}></div>

                        {/* Left Side: Hero (Visible on Desktop) */}
                        <div className="relative z-10 flex-1 flex flex-col justify-center p-8 md:p-20 lg:p-24 animate-enter">
                            <div className="inline-flex self-start items-center gap-2 px-4 py-2 rounded-full bg-white/5 backdrop-blur-md border border-white/10 mb-8 shadow-lg">
                                <span className="w-2 h-2 rounded-full bg-emerald-400 animate-pulse shadow-[0_0_10px_#34d399]"></span>
                                <span className="text-xs font-bold tracking-widest uppercase text-slate-300">Live Status: Online</span>
                            </div>
                            <h1 className="text-5xl md:text-7xl lg:text-8xl font-black tracking-tighter leading-[0.9] mb-12 drop-shadow-2xl">
                                Trip <br/>
                                <span className="text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 via-purple-400 to-cyan-400">Tracker.</span>
                            </h1>
                            
                            {/* Interactive Premium Animation */}
                            <div className="relative w-64 h-64 hidden md:block">
                                {/* Radar Waves */}
                                <div className="absolute inset-0 bg-indigo-500/20 rounded-full animate-ping" style={{ animationDuration: '3s' }}></div>
                                <div className="absolute inset-8 bg-violet-500/10 rounded-full animate-ping" style={{ animationDuration: '4s', animationDelay: '1s' }}></div>
                                
                                {/* Central Hub */}
                                <div className="absolute inset-16 bg-white/5 rounded-full backdrop-blur-xl border border-white/10 flex items-center justify-center shadow-[0_0_40px_rgba(99,102,241,0.3)]">
                                    <Bus className="w-16 h-16 text-indigo-300 drop-shadow-lg" />
                                </div>
                                
                                {/* Floating Orbiting Elements */}
                                <div className="absolute top-0 right-10 p-3 bg-emerald-500/10 rounded-full border border-emerald-500/30 backdrop-blur-md animate-bounce" style={{ animationDuration: '3s' }}>
                                    <CheckCircle2 className="w-6 h-6 text-emerald-400" />
                                </div>
                                <div className="absolute bottom-10 left-0 p-3 bg-rose-500/10 rounded-full border border-rose-500/30 backdrop-blur-md animate-bounce" style={{ animationDuration: '4s', animationDelay: '0.5s' }}>
                                    <MapPin className="w-6 h-6 text-rose-400" />
                                </div>
                                <div className="absolute top-10 left-10 w-3 h-3 bg-amber-400 rounded-full shadow-[0_0_10px_#fbbf24] animate-pulse"></div>
                            </div>
                        </div>

                        {/* Right Side: Login Interaction (Full width bottom on Mobile, Side on Desktop) */}
                        <div className="relative z-20 w-full md:w-[500px] bg-white/5 md:bg-white/5 backdrop-blur-2xl border-t md:border-l border-white/10 flex flex-col justify-center p-8 md:p-12 shadow-2xl animate-slide-up md:animate-none">
                            
                            {!selectedTeacherId ? (
                                <div className="space-y-8">
                                    <div>
                                        <h2 className="text-2xl font-bold mb-2 tracking-tight">Welcome Back</h2>
                                        <p className="text-slate-400 text-sm">Select your profile to continue.</p>
                                    </div>

                                    {/* Admin Quick Access */}
                                    <div className="p-1 rounded-2xl bg-slate-900/50 border border-white/10">
                                        <button 
                                            onClick={() => { setSelectedTeacherId('admin-login-flow'); setLoginError(''); }} // Hack to show admin flow
                                            className="w-full flex items-center justify-between p-4 rounded-xl hover:bg-white/5 transition-all group"
                                        >
                                            <div className="flex items-center gap-4">
                                                <div className="w-10 h-10 rounded-full bg-gradient-to-br from-slate-700 to-slate-900 flex items-center justify-center border border-white/10 group-hover:scale-110 transition-transform">
                                                    <Shield className="w-5 h-5 text-white" />
                                                </div>
                                                <div className="text-left">
                                                    <div className="font-bold text-white">Admin Access</div>
                                                    <div className="text-xs text-slate-500">Manage trip settings</div>
                                                </div>
                                            </div>
                                            <ChevronRight className="w-5 h-5 text-slate-600 group-hover:text-white transition-colors" />
                                        </button>
                                    </div>

                                    {/* Teacher List */}
                                    <div>
                                        <h3 className="text-xs font-bold text-slate-500 uppercase tracking-widest mb-4 flex items-center gap-2"><GraduationCap className="w-4 h-4"/> Faculty Profiles</h3>
                                        <div className="space-y-2 max-h-[300px] overflow-y-auto pr-2 scrollbar-hide">
                                            {teachers.length === 0 ? (
                                                <div className="text-center py-8 border border-dashed border-white/10 rounded-2xl">
                                                    <p className="text-slate-500 text-sm">No profiles found.</p>
                                                </div>
                                            ) : (
                                                teachers.map(t => (
                                                    <button 
                                                        key={t.id} 
                                                        onClick={() => setSelectedTeacherId(t.id)}
                                                        className="w-full flex items-center gap-4 p-3 rounded-xl hover:bg-white/10 transition-all text-left group border border-transparent hover:border-white/5"
                                                    >
                                                        <div className="w-10 h-10 rounded-full bg-indigo-500/20 text-indigo-300 flex items-center justify-center font-bold text-sm border border-indigo-500/30 group-hover:bg-indigo-500 group-hover:text-white transition-colors">
                                                            {t.name.charAt(0)}
                                                        </div>
                                                        <span className="font-medium text-slate-200 group-hover:text-white">{t.name}</span>
                                                    </button>
                                                ))
                                            )}
                                        </div>
                                    </div>
                                </div>
                            ) : (
                                // LOGIN FORM VIEW
                                <div className="animate-enter">
                                    <button 
                                        onClick={() => { setSelectedTeacherId(null); setLoginError(''); setLoginPasscode(''); setTeacherLoginPassword(''); }}
                                        className="mb-8 flex items-center gap-2 text-sm text-slate-400 hover:text-white transition-colors"
                                    >
                                        <ArrowLeft className="w-4 h-4" /> Back to profiles
                                    </button>

                                    {selectedTeacherId === 'admin-login-flow' ? (
                                        // ADMIN FORM
                                        <div className="space-y-6">
                                            <div>
                                                <div className="w-16 h-16 rounded-3xl bg-gradient-to-br from-slate-700 to-slate-800 flex items-center justify-center mb-6 shadow-xl border border-white/10">
                                                    <Shield className="w-8 h-8 text-white" />
                                                </div>
                                                <h2 className="text-3xl font-bold text-white">Admin Login</h2>
                                                <p className="text-slate-400 mt-2">Enter the trip master passcode.</p>
                                            </div>
                                            <form onSubmit={handleAdminLogin} className="space-y-4">
                                                <div className="relative group">
                                                    <div className="absolute -inset-0.5 bg-gradient-to-r from-indigo-500 to-cyan-500 rounded-xl opacity-0 group-focus-within:opacity-100 transition duration-500 blur"></div>
                                                    <div className="relative flex items-center bg-slate-900 rounded-xl border border-white/10">
                                                        <KeyRound className="w-5 h-5 text-slate-500 ml-4" />
                                                        <input 
                                                            type="password" 
                                                            autoFocus
                                                            placeholder="Passcode" 
                                                            className="w-full bg-transparent p-4 text-white placeholder-slate-600 outline-none font-mono text-lg tracking-widest"
                                                            value={loginPasscode} 
                                                            onChange={(e) => setLoginPasscode(e.target.value)} 
                                                        />
                                                    </div>
                                                </div>
                                                <button type="submit" className="w-full py-4 bg-white text-slate-900 rounded-xl font-bold text-lg hover:bg-slate-200 transition-colors shadow-lg active:scale-[0.98]">
                                                    Unlock Dashboard
                                                </button>
                                            </form>
                                        </div>
                                    ) : (
                                        // TEACHER FORM
                                        <div className="space-y-6">
                                            <div>
                                                <div className="w-16 h-16 rounded-3xl bg-gradient-to-br from-indigo-600 to-violet-600 flex items-center justify-center mb-6 shadow-xl border border-white/10">
                                                    <GraduationCap className="w-8 h-8 text-white" />
                                                </div>
                                                <h2 className="text-3xl font-bold text-white">
                                                    Hello, {teachers.find(t => t.id === selectedTeacherId)?.name}
                                                </h2>
                                                <p className="text-slate-400 mt-2">Please enter your personal password.</p>
                                            </div>
                                            <form onSubmit={submitTeacherLogin} className="space-y-4">
                                                <div className="relative group">
                                                    <div className="absolute -inset-0.5 bg-gradient-to-r from-violet-500 to-fuchsia-500 rounded-xl opacity-0 group-focus-within:opacity-100 transition duration-500 blur"></div>
                                                    <div className="relative flex items-center bg-slate-900 rounded-xl border border-white/10">
                                                        <Lock className="w-5 h-5 text-slate-500 ml-4" />
                                                        <input 
                                                            type="password" 
                                                            autoFocus
                                                            placeholder="Password" 
                                                            className="w-full bg-transparent p-4 text-white placeholder-slate-600 outline-none text-lg"
                                                            value={teacherLoginPassword} 
                                                            onChange={(e) => setTeacherLoginPassword(e.target.value)} 
                                                        />
                                                    </div>
                                                </div>
                                                <button type="submit" className="w-full py-4 bg-indigo-600 text-white rounded-xl font-bold text-lg hover:bg-indigo-500 transition-colors shadow-lg shadow-indigo-900/50 active:scale-[0.98]">
                                                    Sign In
                                                </button>
                                            </form>
                                        </div>
                                    )}

                                    {loginError && (
                                        <div className="mt-6 p-4 bg-rose-500/10 border border-rose-500/20 rounded-xl flex items-center gap-3 animate-pulse">
                                            <AlertTriangle className="w-5 h-5 text-rose-500" />
                                            <span className="text-rose-200 text-sm font-medium">{loginError}</span>
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>
                    </div>
                );
            }

            // 3. MAIN DASHBOARD (Wrapper for content)
            // Note: Keeping previous dashboard code exactly as it was, just ensuring it renders when role is set
            return (
                <div className="min-h-screen font-sans bg-mesh transition-colors duration-500 pb-32 text-slate-900 dark:text-slate-100">
                    {/* ... (Previous Dashboard Code) ... */}
                    {/* Re-pasting the Dashboard logic for completeness within the artifact */}
                    {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}
                    {globalSettings.sos && (<div className="fixed inset-0 z-[999] flex items-center justify-center bg-rose-950/90 backdrop-blur-md animate-pulse"><div className="bg-white dark:bg-slate-900 p-8 rounded-3xl shadow-2xl text-center max-w-sm mx-4 border-4 border-rose-500 ring-4 ring-rose-500/30"><AlertOctagon className="w-24 h-24 text-rose-600 mx-auto mb-6 animate-bounce filter drop-shadow-lg" /><h1 className="text-4xl font-black text-rose-600 mb-2 tracking-tight">EMERGENCY</h1><p className="text-xl font-bold text-slate-800 dark:text-white mb-8">RETURN TO BUS IMMEDIATELY</p>{role === 'admin' && (<button onClick={toggleSOS} className="bg-rose-600 text-white px-10 py-4 rounded-2xl font-bold text-lg hover:bg-rose-700 shadow-xl shadow-rose-600/40 active:scale-95 transition-transform">Dismiss Alert</button>)}</div></div>)}
                    <header className={`sticky top-0 z-40 transition-all duration-500 shadow-2xl shadow-indigo-900/10 rounded-b-[2.5rem] overflow-hidden ${allAboard ? 'bg-gradient-to-r from-emerald-600 to-teal-600' : 'bg-gradient-to-r from-indigo-700 to-violet-800'}`}><div className="h-1.5 w-full bg-black/20 relative"><div className="absolute top-0 left-0 h-full bg-white/70 shadow-[0_0_10px_rgba(255,255,255,0.8)] transition-all duration-1000 ease-out rounded-r-full" style={{ width: `${progress}%` }}></div></div><div className="max-w-xl mx-auto px-6 py-5"><div className="flex justify-between items-start mb-6"><div><div className="flex items-center gap-2 mb-1.5"><span className="glass-panel px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-widest text-white border-0 bg-white/10 backdrop-blur-md">{role === 'admin' ? 'Command Center' : 'Faculty View'}</span></div><h1 className="font-bold text-2xl flex items-center gap-2 text-white tracking-tight drop-shadow-md">{role === 'admin' ? 'Trip Control' : `Hi, ${currentTeacherProfile?.name}`}</h1></div><div className="flex gap-3"><button onClick={() => setDarkMode(!darkMode)} className="p-3 bg-white/10 hover:bg-white/20 rounded-2xl backdrop-blur-md transition text-white border border-white/10 active:scale-95">{darkMode ? <Sun className="w-5 h-5"/> : <Moon className="w-5 h-5"/>}</button><button onClick={logout} className="p-3 bg-white/10 hover:bg-white/20 rounded-2xl backdrop-blur-md transition text-white border border-white/10 active:scale-95"><LogOut className="w-5 h-5" /></button></div></div><div className="glass-panel rounded-3xl p-5 mb-5 shadow-lg relative overflow-hidden group bg-white/10 border-white/20"><div className="flex items-center gap-2 text-indigo-100 text-xs uppercase tracking-widest mb-1.5 font-bold opacity-80"><MapPin className="w-3 h-3" /> Current Destination</div>{role === 'admin' && isEditingLocation ? (<div className="flex gap-2 mt-2 animate-in fade-in"><input autoFocus value={tempLocationName} onChange={(e) => setTempLocationName(e.target.value)} className="flex-1 bg-white/90 text-slate-900 px-4 py-2 rounded-xl text-xl font-bold outline-none shadow-lg"/><button onClick={updateLocationName} className="bg-emerald-500 text-white px-4 py-2 rounded-xl shadow-lg active:scale-95"><Save className="w-6 h-6" /></button></div>) : (<div className="flex justify-between items-center"><h2 className="text-3xl font-extrabold text-white leading-none tracking-tight drop-shadow-md">{globalSettings.locationName}</h2>{role === 'admin' && <button onClick={() => { setIsEditingLocation(true); setTempLocationName(globalSettings.locationName); }} className="p-2 bg-white/10 hover:bg-white/20 rounded-full active:scale-95 text-white transition-colors"><Edit3 className="w-5 h-5" /></button>}</div>)}</div><div className="flex items-center gap-4"><div className="flex-1 bg-black/20 rounded-2xl p-4 backdrop-blur-md flex flex-col items-center justify-center shadow-lg border border-white/5 relative overflow-hidden"><span className="text-[10px] uppercase text-white/70 font-bold mb-1 tracking-widest z-10">On Bus</span><span className="text-3xl font-black text-white z-10">{studentsOnBusCount} <span className="text-lg font-medium opacity-50">/ {totalCount}</span></span></div><div className={`flex-1 rounded-2xl p-4 flex flex-col items-center justify-center shadow-lg transition-all duration-500 border border-white/10 relative overflow-hidden ${allAboard ? 'bg-emerald-500/30' : 'bg-rose-500/80 animate-pulse-glow'}`}>{allAboard ? <><div className="absolute inset-0 bg-emerald-400/20 blur-xl"></div><CheckCircle2 className="w-8 h-8 text-white mb-1 z-10 drop-shadow-sm"/><span className="text-[10px] font-bold text-white uppercase tracking-widest z-10">Ready</span></> : <><span className="text-3xl font-black text-white z-10">{missingCount}</span><span className="text-[10px] font-bold text-white uppercase tracking-widest z-10">Missing</span></>}</div></div></div></header>
                    <div className="glass-panel sticky top-[220px] z-30 overflow-x-auto border-b border-slate-200/50 dark:border-slate-800/50 mx-4 mt-4 rounded-2xl shadow-sm"><div className="flex min-w-full p-1 gap-2">{[{ id: 'monitor', label: 'Monitor' }, { id: 'schedule', label: 'Schedule' }, { id: 'alerts', label: 'Alerts' }, { id: 'students', label: 'Students' }].concat(role === 'admin' ? [{ id: 'teachers', label: 'Faculty' }, { id: 'settings', label: 'Settings' }] : []).map((tab) => (<button key={tab.id} onClick={() => setActiveTab(tab.id)} className={`flex-none px-4 whitespace-nowrap py-3 text-xs font-bold uppercase tracking-widest rounded-xl transition-all ${activeTab === tab.id ? 'bg-indigo-600 text-white shadow-md' : 'text-slate-500 hover:bg-slate-100 dark:text-slate-400 dark:hover:bg-slate-800'}`}>{tab.label}</button>))}</div></div>
                    {/* Announcement Banner */}
                    {globalSettings.announcement && (<div className="mx-4 mt-4 bg-gradient-to-r from-amber-400 to-orange-400 text-white px-5 py-4 text-sm font-bold flex items-center justify-between shadow-lg z-20 relative rounded-2xl animate-enter"><div className="flex items-center gap-3"><div className="bg-white/20 p-2 rounded-full"><Megaphone className="w-5 h-5 flex-shrink-0" /></div><span className="drop-shadow-sm">{globalSettings.announcement}</span></div>{role === 'admin' && (<button onClick={clearBroadcast} className="p-2 hover:bg-white/20 rounded-full transition"><X className="w-4 h-4" /></button>)}</div>)}
                    <main className="max-w-xl mx-auto px-4 py-6 space-y-6">
                        {/* --- MONITOR TAB --- */}
                        {activeTab === 'monitor' && (
                            <div className="space-y-6">
                                {role === 'admin' && (
                                    <div className="space-y-4">
                                        <div className="flex items-center gap-3"><div className="flex-1 glass-panel p-2 rounded-2xl shadow-sm flex items-center gap-3 focus-within:ring-2 focus-within:ring-indigo-500/50 transition-all bg-white/50 dark:bg-slate-800/50"><Search className="w-5 h-5 text-slate-400 ml-2" /><input placeholder="Search..." className="flex-1 bg-transparent outline-none p-2 text-slate-700 dark:text-white font-medium w-full placeholder-slate-400" value={searchQuery} onChange={(e) => setSearchQuery(e.target.value)} />{searchQuery && <button onClick={() => setSearchQuery('')} className="p-2 hover:bg-slate-200 dark:hover:bg-slate-700 rounded-xl text-slate-400 transition"><X className="w-4 h-4"/></button>}</div>{uniqueBuses.length > 0 && (<select value={busFilter} onChange={e => setBusFilter(e.target.value)} className="p-4 bg-white dark:bg-slate-800 text-indigo-600 dark:text-indigo-400 rounded-2xl border border-indigo-100 dark:border-slate-700 shadow-md font-bold outline-none"><option value="all">All Buses</option>{uniqueBuses.map(b => <option key={b} value={b}>{b}</option>)}</select>)}</div>
                                    </div>
                                )}
                                <div className="flex gap-3 overflow-x-auto pb-2 mt-2 -mx-4 px-4 scrollbar-hide"><button onClick={() => setViewMode(viewMode === 'all' ? 'missing' : 'all')} className={`flex-1 min-w-[140px] py-3.5 rounded-2xl text-sm font-bold shadow-sm border transition-all active:scale-95 flex items-center justify-center gap-2 whitespace-nowrap ${viewMode === 'missing' ? 'bg-amber-100/80 dark:bg-amber-900/40 border-amber-200 dark:border-amber-700 text-amber-800 dark:text-amber-200 backdrop-blur-md' : 'glass-panel text-slate-600 dark:text-slate-300'}`}><Filter className="w-4 h-4"/> {viewMode === 'missing' ? 'Show All' : 'Missing Only'}</button><button onClick={() => markBatch(false)} className="px-5 glass-panel rounded-2xl text-rose-500 hover:bg-rose-50 dark:hover:bg-rose-900/20 active:scale-95 transition-all flex items-center gap-2 font-bold text-xs whitespace-nowrap"><RotateCcw className="w-4 h-4" /> Reset All</button><button onClick={() => markBatch(true)} className="px-5 glass-panel rounded-2xl text-emerald-600 hover:bg-emerald-50 dark:hover:bg-emerald-900/20 active:scale-95 transition-all flex items-center gap-2 font-bold text-xs whitespace-nowrap"><CheckCircle2 className="w-4 h-4" /> Board All</button></div>
                                <div className="space-y-4">
                                    {filteredStudents.length === 0 ? <div className="glass-panel rounded-3xl p-10 text-center flex flex-col items-center"><div className="bg-slate-100 dark:bg-slate-700 p-4 rounded-full mb-4"><Users className="w-8 h-8 text-slate-400" /></div><p className="text-slate-500 dark:text-slate-400 font-medium">No students match.</p></div> : 
                                        filteredStudents.map((student, index) => {
                                            const hasNote = student.note && student.note.trim().length > 0;
                                            return (
                                                <div key={student.id} onClick={() => toggleStudentStatus(student)} style={{ animation: `enter 0.4s ease-out forwards ${index * 0.05}s`, opacity: 0 }} className={`relative overflow-hidden group cursor-pointer select-none flex items-center justify-between p-5 rounded-3xl shadow-sm transition-all duration-300 active:scale-[0.97] glass-panel ${student.onBus ? 'border-emerald-500/20 dark:border-emerald-500/30' : 'border-rose-500/30 dark:border-rose-500/40 shadow-rose-500/10'}`}>
                                                    <div className="flex items-center gap-5 relative z-10 flex-1 min-w-0"><div className={`w-14 h-14 rounded-2xl flex-shrink-0 flex items-center justify-center font-bold text-xl shadow-inner transition-colors duration-300 ${student.onBus ? 'bg-emerald-100 text-emerald-600 dark:bg-emerald-900/40 dark:text-emerald-400' : 'bg-rose-100 text-rose-600 dark:bg-rose-900/40 dark:text-rose-400'}`}>{student.class || "?"}</div><div className="min-w-0 flex-1"><div className="flex items-center gap-2 mb-1"><h3 onClick={(e) => { e.stopPropagation(); setViewProfile(student); }} className="font-bold text-lg truncate hover:text-indigo-600 dark:hover:text-indigo-400 transition-colors text-slate-800 dark:text-slate-100">{student.name}</h3>{hasNote && <div className="bg-amber-100 dark:bg-amber-900/50 p-1 rounded-md"><AlertOctagon className="w-3 h-3 text-amber-600 dark:text-amber-400" /></div>}</div><div className="flex flex-wrap gap-2 items-center"><button onClick={(e) => { e.stopPropagation(); setNoteStudent(student); }} className={`text-[10px] px-2.5 py-1 rounded-lg flex items-center gap-1 transition-colors font-bold ${hasNote ? 'bg-amber-100 dark:bg-amber-900/30 text-amber-700 dark:text-amber-300' : 'bg-slate-100 dark:bg-slate-700 text-slate-500'}`}><StickyNote className="w-3 h-3" /> {hasNote ? 'Info' : 'Note'}</button>{student.bus && <span className="text-[10px] font-bold bg-indigo-100 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400 px-2 py-1 rounded-lg flex items-center gap-1"><Bus className="w-3 h-3"/>{student.bus}</span>}</div></div></div><div className="flex items-center gap-3 relative z-10 flex-shrink-0 pl-3"><div className={`p-2 rounded-full transition-all duration-300 shadow-sm ${student.onBus ? 'bg-emerald-100 dark:bg-emerald-900/30 text-emerald-600' : 'bg-rose-100 dark:bg-rose-900/30 text-rose-600'}`}>{student.onBus ? <CheckCircle2 className="w-6 h-6"/> : <XCircle className="w-6 h-6"/>}</div></div>{!student.onBus && <div className="absolute inset-0 bg-rose-50/40 dark:bg-rose-900/10 z-0 pointer-events-none transition-opacity duration-300"></div>}</div>
                                            );
                                        })
                                    }
                                </div>
                            </div>
                        )}
                        {/* --- SCHEDULE TAB --- */}
                        {activeTab === 'schedule' && (
                            <div className="space-y-6 animate-enter">
                                {role === 'admin' && (<div className="glass-panel p-6 rounded-3xl shadow-sm"><h3 className="font-bold text-lg mb-4 flex items-center gap-3 text-slate-800 dark:text-slate-100"><div className="p-2 bg-indigo-100 dark:bg-indigo-900/30 rounded-xl text-indigo-600"><Plus className="w-5 h-5"/></div> Add Event</h3><form onSubmit={addScheduleItem} className="flex gap-2"><input type="time" className="px-4 py-3 bg-white/50 dark:bg-slate-900/50 border border-slate-200 dark:border-slate-700 rounded-xl outline-none dark:text-white" value={scheduleForm.time} onChange={e => setScheduleForm({...scheduleForm, time: e.target.value})} /><input className="flex-1 px-4 py-3 bg-white/50 dark:bg-slate-900/50 border border-slate-200 dark:border-slate-700 rounded-xl outline-none dark:text-white" placeholder="Description" value={scheduleForm.title} onChange={e => setScheduleForm({...scheduleForm, title: e.target.value})} /><button type="submit" className="px-4 bg-indigo-600 text-white rounded-xl font-bold"><Plus className="w-5 h-5" /></button></form></div>)}
                                <div className="space-y-4">{schedule.length === 0 ? <p className="text-center text-slate-400 italic">No events scheduled.</p> : schedule.map((item, i) => (<div key={item.id} className="flex gap-4 items-center animate-enter" style={{ animationDelay: `${i*0.1}s` }}><div className="w-20 text-right text-sm font-bold text-indigo-600 dark:text-indigo-400">{item.time}</div><div className="w-3 h-3 rounded-full bg-indigo-400 relative"><div className="absolute top-3 left-1.5 w-0.5 h-16 bg-indigo-200 dark:bg-indigo-900/30 -translate-x-1/2"></div></div><div className="flex-1 glass-panel p-4 rounded-xl flex justify-between items-center"><span className="font-medium text-slate-800 dark:text-slate-200">{item.title}</span>{role === 'admin' && <button onClick={() => deleteScheduleItem(item.id)} className="text-rose-400 hover:text-rose-600"><Trash2 className="w-4 h-4"/></button>}</div></div>))}</div>
                            </div>
                        )}
                        {/* --- NOTIFICATIONS / ALERTS TAB --- */}
                        {activeTab === 'alerts' && (
                            <div className="space-y-6 animate-enter">
                                <div className="glass-panel p-6 rounded-3xl shadow-sm text-center"><Bell className="w-8 h-8 text-amber-500 mx-auto mb-2" /><h3 className="font-bold text-lg text-slate-800 dark:text-white">Notification History</h3><p className="text-slate-500 text-sm">Log of all past broadcasts</p>{role === 'admin' && <button onClick={() => setShowBroadcastModal(true)} className="mt-4 px-6 py-2 bg-indigo-600 text-white rounded-xl font-bold text-sm shadow-lg active:scale-95">Send New Alert</button>}</div>
                                <div className="space-y-3">{notifications.length === 0 ? <p className="text-center text-slate-400 italic py-8">No alerts sent yet.</p> : notifications.map((notif, i) => (<div key={notif.id} className="glass-panel p-5 rounded-2xl flex gap-4 items-start animate-enter" style={{ animationDelay: `${i*0.05}s` }}><div className="bg-amber-100 dark:bg-amber-900/30 p-2 rounded-full mt-1"><Megaphone className="w-4 h-4 text-amber-600 dark:text-amber-400" /></div><div className="flex-1"><p className="text-slate-800 dark:text-slate-100 font-medium leading-relaxed">{notif.message}</p><div className="text-[10px] text-slate-400 mt-2 font-bold uppercase tracking-wider flex items-center gap-1"><Clock className="w-3 h-3" /> {new Date(notif.createdAt).toLocaleDateString()} â€¢ {new Date(notif.createdAt).toLocaleTimeString()}</div></div></div>))}</div>
                            </div>
                        )}
                        {/* --- STUDENTS TAB --- */}
                        {activeTab === 'students' && (
                            <div className="space-y-6 animate-enter">
                                <div className="glass-panel p-6 rounded-3xl shadow-sm"><h3 className="font-bold text-lg mb-6 flex items-center gap-3 text-slate-800 dark:text-slate-100"><div className="p-2 bg-indigo-100 dark:bg-indigo-900/30 rounded-xl text-indigo-600"><UserPlus className="w-5 h-5"/></div> Add Student</h3><form onSubmit={addStudent} className="space-y-4"><input required placeholder="Student Name" className="w-full px-5 py-4 bg-white/50 dark:bg-slate-900/50 border border-slate-200 dark:border-slate-700 rounded-2xl focus:ring-2 focus:ring-indigo-500 outline-none dark:text-white transition-all" value={studentForm.name} onChange={e => setStudentForm({...studentForm, name: e.target.value})} /><div className="grid grid-cols-2 gap-3"><input required placeholder="Class" className="w-full px-5 py-4 bg-white/50 dark:bg-slate-900/50 border border-slate-200 dark:border-slate-700 rounded-2xl focus:ring-2 focus:ring-indigo-500 outline-none dark:text-white transition-all" value={studentForm.class} onChange={e => setStudentForm({...studentForm, class: e.target.value})} /><input placeholder="Bus No." className="w-full px-5 py-4 bg-white/50 dark:bg-slate-900/50 border border-slate-200 dark:border-slate-700 rounded-2xl focus:ring-2 focus:ring-indigo-500 outline-none dark:text-white transition-all" value={studentForm.bus} onChange={e => setStudentForm({...studentForm, bus: e.target.value})} /></div><input type="tel" placeholder="Parent Contact" className="w-full px-5 py-4 bg-white/50 dark:bg-slate-900/50 border border-slate-200 dark:border-slate-700 rounded-2xl focus:ring-2 focus:ring-indigo-500 outline-none dark:text-white transition-all" value={studentForm.contact} onChange={e => setStudentForm({...studentForm, contact: e.target.value})} /><input type="tel" placeholder="Student Phone" className="w-full px-5 py-4 bg-white/50 dark:bg-slate-900/50 border border-slate-200 dark:border-slate-700 rounded-2xl focus:ring-2 focus:ring-indigo-500 outline-none dark:text-white transition-all" value={studentForm.personalContact} onChange={e => setStudentForm({...studentForm, personalContact: e.target.value})} /><select className="w-full px-5 py-4 bg-white/50 dark:bg-slate-900/50 border border-slate-200 dark:border-slate-700 rounded-2xl focus:ring-2 focus:ring-indigo-500 outline-none dark:text-white transition-all" value={studentForm.assignedTeacherId} onChange={e => setStudentForm({...studentForm, assignedTeacherId: e.target.value})}><option value="">-- Assign Teacher --</option>{teachers.map(t => <option key={t.id} value={t.id}>{t.name}</option>)}</select><button type="submit" className="w-full py-4 bg-gradient-to-r from-indigo-600 to-violet-600 text-white rounded-2xl font-bold shadow-lg shadow-indigo-500/30 hover:shadow-indigo-500/50 active:scale-95 transition-all">Add Student</button></form></div>
                                <div className="space-y-3"><h3 className="font-bold text-slate-400 text-xs uppercase tracking-widest ml-1">Registry ({students.length})</h3>{students.map((s, i) => (<div key={s.id} className="glass-panel p-4 rounded-2xl flex justify-between items-center group" style={{ animationDelay: `${i*0.03}s` }}><div><div className="flex items-baseline gap-2"><span className="font-bold text-slate-800 dark:text-white">{s.name}</span><span className="text-xs font-bold text-indigo-600 dark:text-indigo-400 bg-indigo-50 dark:bg-indigo-900/30 px-2 py-0.5 rounded-md">{s.class}</span>{s.bus && <span className="text-xs text-slate-500 bg-slate-100 px-2 rounded">Bus {s.bus}</span>}</div></div><div className="flex gap-2"><button onClick={() => setEditingStudent(s)} className="p-2 text-slate-400 hover:text-indigo-600 bg-slate-50 dark:bg-slate-800 rounded-xl transition-colors"><Edit3 className="w-4 h-4"/></button><button onClick={() => deleteStudent(s.id)} className="p-2 text-slate-400 hover:text-rose-500 bg-slate-50 dark:bg-slate-800 rounded-xl transition-colors"><Trash2 className="w-4 h-4"/></button></div></div>))}</div>
                            </div>
                        )}
                        {/* --- TEACHERS TAB --- */}
                        {activeTab === 'teachers' && (
                            <div className="space-y-6 animate-enter">
                                <div className="glass-panel p-6 rounded-3xl shadow-sm"><h3 className="font-bold text-lg mb-6 flex items-center gap-3 text-slate-800 dark:text-slate-100"><div className="p-2 bg-emerald-100 dark:bg-emerald-900/30 rounded-xl text-emerald-600"><GraduationCap className="w-5 h-5"/></div> Add Faculty</h3><form onSubmit={addTeacher} className="flex flex-col gap-3"><div className="flex gap-3"><input required placeholder="Name" className="flex-1 px-5 py-4 bg-white/50 dark:bg-slate-900/50 border border-slate-200 dark:border-slate-700 rounded-2xl focus:ring-2 focus:ring-emerald-500 outline-none dark:text-white transition-all" value={teacherForm.name} onChange={e => setTeacherForm({...teacherForm, name: e.target.value})} /><input required type="text" placeholder="Pass" className="w-1/3 px-5 py-4 bg-white/50 dark:bg-slate-900/50 border border-slate-200 dark:border-slate-700 rounded-2xl focus:ring-2 focus:ring-emerald-500 outline-none dark:text-white transition-all" value={teacherForm.password} onChange={e => setTeacherForm({...teacherForm, password: e.target.value})} /></div><button type="submit" className="w-full py-4 bg-gradient-to-r from-emerald-500 to-teal-500 text-white rounded-2xl font-bold shadow-lg shadow-emerald-500/30 hover:shadow-emerald-500/50 active:scale-95 transition-all">Create Profile</button></form></div>
                                <div className="space-y-3"><h3 className="font-bold text-slate-400 text-xs uppercase tracking-widest ml-1">Faculty Team</h3>{teachers.map((t, i) => (<div key={t.id} className="glass-panel p-4 rounded-2xl flex justify-between items-center" style={{ animationDelay: `${i*0.05}s` }}><div className="flex items-center gap-4"><div className="w-12 h-12 rounded-2xl bg-indigo-100 dark:bg-indigo-900/50 flex items-center justify-center font-bold text-lg text-indigo-700 dark:text-indigo-300 shadow-sm">{t.name.charAt(0)}</div><div><div className="font-bold text-slate-700 dark:text-white text-lg">{t.name}</div><div className="text-xs text-slate-400 font-mono bg-slate-100 dark:bg-slate-800 px-2 py-0.5 rounded-md inline-block mt-1">PW: {t.password}</div></div></div><button onClick={() => deleteTeacher(t.id)} className="p-3 text-slate-300 hover:text-rose-500 hover:bg-rose-50 dark:hover:bg-rose-900/20 rounded-xl transition-all"><Trash2 className="w-5 h-5"/></button></div>))}</div>
                            </div>
                        )}
                        {/* Settings Tab reuse */}
                        {activeTab === 'settings' && role === 'admin' && (
                            <div className="space-y-6 animate-enter">
                                <div className="glass-panel rounded-3xl overflow-hidden shadow-sm"><div className="p-5 border-b border-slate-200/50 dark:border-slate-700/50 flex items-center gap-3 bg-white/40 dark:bg-slate-800/40"><div className="p-2 bg-indigo-50 dark:bg-indigo-900/30 rounded-xl"><Shield className="w-5 h-5 text-indigo-600 dark:text-indigo-400" /></div><h3 className="font-bold text-slate-700 dark:text-slate-200">Admin Security</h3></div><div className="p-6"><form onSubmit={updateAdminPasscode} className="flex gap-3"><input type="text" placeholder="New Passcode" className="w-full px-4 py-3 bg-white/50 dark:bg-slate-900/50 border border-slate-200 dark:border-slate-700 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none dark:text-white" value={newAdminPasscode} onChange={(e) => setNewAdminPasscode(e.target.value)} /><button type="submit" className="px-6 py-2 bg-indigo-600 text-white rounded-xl font-bold flex-shrink-0 active:scale-95 shadow-lg shadow-indigo-500/30">Update</button></form><p className="text-xs text-slate-400 mt-3 font-mono">Current: {globalSettings.adminPasscode}</p></div></div>
                                <div className="glass-panel rounded-3xl overflow-hidden shadow-sm"><div className="p-5 border-b border-slate-200/50 dark:border-slate-700/50 flex items-center gap-3 bg-white/40 dark:bg-slate-800/40"><div className="p-2 bg-emerald-50 dark:bg-emerald-900/30 rounded-xl"><FileSpreadsheet className="w-5 h-5 text-emerald-600 dark:text-emerald-400" /></div><h3 className="font-bold text-slate-700 dark:text-slate-200">Reports</h3></div><div className="p-6 grid gap-4"><button onClick={handlePrint} className="flex items-center justify-between p-4 bg-white/50 dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700 rounded-2xl group hover:border-emerald-400 transition-colors flex-shrink-0"><div className="text-left"><div className="font-bold text-emerald-900 dark:text-emerald-300">Print PDF Report</div></div><div className="p-2 bg-emerald-100 dark:bg-emerald-900/50 rounded-lg text-emerald-600"><Printer className="w-5 h-5" /></div></button><button onClick={copyReport} className="flex items-center justify-between p-4 bg-white/50 dark:bg-slate-800/50 border border-slate-200 dark:border-slate-700 rounded-2xl group hover:border-indigo-400 transition-colors flex-shrink-0"><div className="text-left"><div className="font-bold text-indigo-900 dark:text-indigo-300">Copy Text Summary</div></div><div className="p-2 bg-indigo-100 dark:bg-indigo-900/50 rounded-lg text-indigo-600"><Clipboard className="w-5 h-5" /></div></button></div></div>
                                <div className="glass-panel rounded-3xl overflow-hidden shadow-sm"><div className="p-5 border-b border-slate-200/50 dark:border-slate-700/50 flex items-center gap-3 bg-white/40 dark:bg-slate-800/40"><div className="p-2 bg-rose-50 dark:bg-rose-900/30 rounded-xl"><SettingsIcon className="w-5 h-5 text-rose-600 dark:text-rose-400" /></div><h3 className="font-bold text-slate-700 dark:text-slate-200">System</h3></div><div className="p-6 space-y-4"><div className="flex items-center justify-between p-4 bg-rose-50 dark:bg-rose-900/20 border border-rose-100 dark:border-rose-800 rounded-xl"><div><div className="font-bold text-rose-900 dark:text-rose-300 flex items-center gap-2"><AlertOctagon className="w-5 h-5" /> SOS Mode</div></div><button onClick={toggleSOS} className={`px-4 py-2 rounded-lg font-bold text-sm transition-all shadow-md flex-shrink-0 ${globalSettings.sos ? 'bg-rose-600 text-white animate-pulse' : 'bg-white text-rose-600 border border-rose-200'}`}>{globalSettings.sos ? 'DEACTIVATE' : 'ACTIVATE'}</button></div><div className="flex items-center justify-between p-4 bg-slate-50 dark:bg-slate-700/30 border border-slate-200 dark:border-slate-700 rounded-xl"><div><div className="font-bold text-slate-700 dark:text-slate-200 flex items-center gap-2"><RefreshCw className="w-5 h-5" /> Reset Trip</div></div><button onClick={resetAllStatuses} className="px-4 py-2 bg-white dark:bg-slate-600 text-slate-600 dark:text-white border border-slate-300 dark:border-slate-500 rounded-lg font-bold text-sm shadow-sm flex-shrink-0">Reset</button></div></div></div>
                            </div>
                        )}
                    </main>

                    {/* --- MODALS (Profile/Edit/Note) --- */}
                    {viewProfile && (
                        <div className="fixed inset-0 z-[999] flex items-end sm:items-center justify-center bg-black/40 backdrop-blur-md p-4 animate-in fade-in duration-200"><div className="glass-panel w-full max-w-sm rounded-[2.5rem] p-8 shadow-2xl animate-in slide-in-from-bottom-10 relative bg-white/90 dark:bg-slate-900/90 border border-white/50"><button onClick={() => setViewProfile(null)} className="absolute top-6 right-6 p-2 bg-slate-100 dark:bg-slate-800 rounded-full text-slate-500 hover:bg-slate-200 transition-colors"><X className="w-5 h-5" /></button><div className="text-center mb-8"><div className="w-24 h-24 bg-gradient-to-br from-indigo-100 to-violet-200 dark:from-indigo-900 dark:to-violet-900 text-indigo-600 dark:text-indigo-300 rounded-[2rem] flex items-center justify-center text-4xl font-black mx-auto mb-5 shadow-inner">{viewProfile.name.charAt(0)}</div><h2 className="text-3xl font-black text-slate-900 dark:text-white tracking-tight leading-tight">{viewProfile.name}</h2><div className={`mt-3 inline-flex items-center gap-2 px-4 py-1.5 rounded-full text-xs font-bold uppercase tracking-wider shadow-sm ${viewProfile.onBus ? 'bg-emerald-100 text-emerald-700' : 'bg-rose-100 text-rose-700'}`}>{viewProfile.onBus ? 'On Board' : 'Off Bus'} <Clock className="w-3 h-3" /> {formatTime(viewProfile.lastStatusChange)}</div></div><div className="space-y-4"><div className="flex gap-4"><div className="flex-1 bg-slate-50 dark:bg-slate-800 p-4 rounded-2xl border border-slate-100 dark:border-slate-700 text-center"><div className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">Class</div><div className="text-xl font-bold text-slate-800 dark:text-white">{viewProfile.class}</div></div><div className="flex-1 bg-slate-50 dark:bg-slate-800 p-4 rounded-2xl border border-slate-100 dark:border-slate-700 text-center"><div className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">Bus</div><div className="text-xl font-bold text-indigo-600 dark:text-indigo-400">{viewProfile.bus || '-'}</div></div></div><div className="bg-slate-50 dark:bg-slate-800 p-5 rounded-2xl border border-slate-100 dark:border-slate-700 flex items-center justify-between"><div><div className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">Parent</div><div className="text-lg font-bold text-slate-800 dark:text-white">{viewProfile.contact || 'No Number'}</div></div>{viewProfile.contact && <a href={`tel:${viewProfile.contact}`} className="p-3 bg-emerald-500 text-white rounded-xl shadow-lg active:scale-95"><Phone className="w-5 h-5" /></a>}</div>{viewProfile.personalContact && <div className="bg-slate-50 dark:bg-slate-800 p-5 rounded-2xl border border-slate-100 dark:border-slate-700 flex items-center justify-between"><div><div className="text-xs font-bold text-indigo-400 uppercase tracking-wider mb-1">Student</div><div className="text-lg font-bold text-slate-800 dark:text-white">{viewProfile.personalContact}</div></div><a href={`tel:${viewProfile.personalContact}`} className="p-3 bg-indigo-500 text-white rounded-xl shadow-lg active:scale-95"><Smartphone className="w-5 h-5" /></a></div>}{viewProfile.note && <div className="bg-amber-50 dark:bg-amber-900/30 p-5 rounded-2xl border border-amber-100 dark:border-amber-800/50"><div className="text-xs font-bold text-amber-600 dark:text-amber-400 uppercase tracking-wider mb-2 flex items-center gap-2"><StickyNote className="w-3 h-3" /> Note</div><p className="text-amber-900 dark:text-amber-100 text-sm font-medium">{viewProfile.note}</p></div>}</div></div></div>
                    )}
                    {/* --- EDIT & NOTE MODALS --- */}
                    {(editingStudent || noteStudent) && (<div className="fixed inset-0 z-50 flex items-center justify-center bg-black/40 backdrop-blur-sm p-4 animate-in fade-in"><div className="glass-panel w-full max-w-sm rounded-[2rem] p-6 shadow-2xl bg-white/95 dark:bg-slate-900/95">{noteStudent ? (<><h2 className="text-xl font-bold mb-4 flex items-center gap-2 dark:text-white"><StickyNote className="w-5 h-5 text-amber-500" /> Student Note</h2><textarea autoFocus className="w-full p-4 border border-slate-200 dark:border-slate-700 rounded-xl mb-4 h-32 bg-slate-50 dark:bg-slate-800 dark:text-white resize-none outline-none focus:ring-2 focus:ring-amber-500" placeholder="Medical info..." value={noteStudent.note || ''} onChange={(e) => setNoteStudent({...noteStudent, note: e.target.value})} /><div className="flex gap-3"><button onClick={() => setNoteStudent(null)} className="flex-1 py-3 bg-slate-100 dark:bg-slate-800 font-bold rounded-xl dark:text-white">Close</button><button onClick={saveNote} className="flex-1 py-3 bg-amber-500 text-white font-bold rounded-xl shadow-lg">Save</button></div></>) : (<><h2 className="text-xl font-bold mb-4 flex items-center gap-2 dark:text-white"><Edit3 className="w-5 h-5 text-indigo-500" /> Edit Student</h2><form onSubmit={updateStudent} className="space-y-3"><input className="w-full px-4 py-3 bg-slate-50 dark:bg-slate-800 border-none rounded-xl dark:text-white" value={editingStudent.name} onChange={e => setEditingStudent({...editingStudent, name: e.target.value})} placeholder="Name" /><div className="grid grid-cols-2 gap-3"><input className="w-full px-4 py-3 bg-slate-50 dark:bg-slate-800 border-none rounded-xl dark:text-white" value={editingStudent.class} onChange={e => setEditingStudent({...editingStudent, class: e.target.value})} placeholder="Class" /><input className="w-full px-4 py-3 bg-slate-50 dark:bg-slate-800 border-none rounded-xl dark:text-white" value={editingStudent.contact} onChange={e => setEditingStudent({...editingStudent, contact: e.target.value})} placeholder="Parent" /></div><div className="grid grid-cols-2 gap-3"><input className="w-full px-4 py-3 bg-slate-50 dark:bg-slate-800 border-none rounded-xl dark:text-white" value={editingStudent.personalContact} onChange={e => setEditingStudent({...editingStudent, personalContact: e.target.value})} placeholder="Student Phone" /><input className="w-full px-4 py-3 bg-slate-50 dark:bg-slate-800 border-none rounded-xl dark:text-white" value={editingStudent.bus} onChange={e => setEditingStudent({...editingStudent, bus: e.target.value})} placeholder="Bus" /></div><select className="w-full px-4 py-3 bg-slate-50 dark:bg-slate-800 border-none rounded-xl dark:text-white" value={editingStudent.assignedTeacherId} onChange={e => setEditingStudent({...editingStudent, assignedTeacherId: e.target.value})}><option value="">-- Teacher --</option>{teachers.map(t => <option key={t.id} value={t.id}>{t.name}</option>)}</select><div className="flex gap-3 mt-4"><button type="button" onClick={() => setEditingStudent(null)} className="flex-1 py-3 bg-slate-100 dark:bg-slate-800 font-bold rounded-xl dark:text-white">Cancel</button><button type="submit" className="flex-1 py-3 bg-indigo-600 text-white font-bold rounded-xl shadow-lg">Save</button></div></form></>)}</div></div>)}
                    {/* --- BROADCAST MODAL --- */}
                    {showBroadcastModal && (<div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-6"><div className="bg-white dark:bg-slate-900 w-full max-w-sm rounded-2xl p-6 shadow-2xl animate-in zoom-in-95"><h2 className="text-xl font-bold mb-4 flex items-center gap-2 text-slate-800 dark:text-white"><Megaphone className="w-6 h-6 text-amber-500" /> Broadcast</h2><textarea autoFocus className="w-full p-3 border border-slate-300 dark:border-slate-700 rounded-xl mb-4 focus:ring-2 focus:ring-amber-500 outline-none resize-none h-32 bg-slate-50 dark:bg-slate-800 dark:text-white" placeholder="Message..." value={broadcastMsg} onChange={(e) => setBroadcastMsg(e.target.value)} /><div className="flex gap-3"><button onClick={() => setShowBroadcastModal(false)} className="flex-1 py-3 bg-slate-100 dark:bg-slate-800 font-bold rounded-xl text-slate-600 dark:text-slate-300">Cancel</button><button onClick={sendBroadcast} className="flex-1 py-3 bg-amber-500 hover:bg-amber-600 font-bold rounded-xl text-white shadow-lg">Send</button></div></div></div>)}
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
