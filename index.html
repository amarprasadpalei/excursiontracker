<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Excursion Tracker</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Import Maps: This tells the browser where to find the libraries -->
    <script type="importmap">
    {
        "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.344.0",
            "firebase/app": "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js",
            "firebase/auth": "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js",
            "firebase/firestore": "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js"
        }
    }
    </script>

    <style>
        /* Custom scrollbar hiding for cleaner UI */
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        body {
            background-color: #f8fafc;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect } from 'react';
        import { createRoot } from 'react-dom/client';
        
        // Import Icons
        import { 
            Bus, MapPin, CheckCircle2, XCircle, UserPlus, Users, Filter, 
            Trash2, AlertTriangle, RotateCcw, Loader2, Phone, Shield, 
            GraduationCap, LogOut, Settings as SettingsIcon, UserCheck, Edit3, Save,
            Search, Megaphone, Bell, X, BarChart3, Lock, ArrowLeft, Key,
            FileText, Clipboard, AlertOctagon, StickyNote, Download, Printer,
            RefreshCw, Check, FileSpreadsheet, KeyRound
        } from 'lucide-react';

        // Import Firebase
        import { initializeApp } from "firebase/app";
        import { 
            getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, 
            onSnapshot, query, setDoc, writeBatch
        } from "firebase/firestore";
        import { 
            getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken 
        } from "firebase/auth";

        // --- Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyCJ-FXK3QhjAjR7GgiBZAFfdTKMLm_zjSc",
            authDomain: "excursion-management.firebaseapp.com",
            projectId: "excursion-management",
            storageBucket: "excursion-management.firebasestorage.app",
            messagingSenderId: "876876669096",
            appId: "1:876876669096:web:c7ab2b68141d2850b8629d"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // Using a production ID for your app data
        const appId = 'excursion-manager-production';

        // --- Toast Component ---
        const Toast = ({ message, type, onClose }) => {
            useEffect(() => {
                const timer = setTimeout(onClose, 3000);
                return () => clearTimeout(timer);
            }, [onClose]);

            return (
                <div className={`fixed top-4 left-1/2 -translate-x-1/2 z-[100] flex items-center gap-2 px-6 py-3 rounded-full shadow-2xl animate-in slide-in-from-top-4 fade-in duration-300 ${
                type === 'error' ? 'bg-rose-600 text-white' : 'bg-slate-800 text-white'
                }`}>
                {type === 'success' ? <CheckCircle2 className="w-5 h-5 text-emerald-400" /> : null}
                {type === 'error' ? <AlertTriangle className="w-5 h-5 text-white" /> : null}
                <span className="font-medium text-sm">{message}</span>
                </div>
            );
        };

        function App() {
            // --- Global Auth State ---
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [authError, setAuthError] = useState(null);

            // --- App Logic State ---
            const [role, setRole] = useState(null); // 'admin' | 'teacher' | null
            const [currentTeacherProfile, setCurrentTeacherProfile] = useState(null);
            
            // --- Data State ---
            const [students, setStudents] = useState([]);
            const [teachers, setTeachers] = useState([]);
            // Added adminPasscode to globalSettings state
            const [globalSettings, setGlobalSettings] = useState({ 
                locationName: 'Starting Point', 
                announcement: '', 
                sos: false,
                adminPasscode: '1234' // Default fallback
            });
            
            // --- UI State ---
            const [activeTab, setActiveTab] = useState('monitor'); 
            const [showAddModal, setShowAddModal] = useState(false);
            const [viewMode, setViewMode] = useState('all'); 
            const [isEditingLocation, setIsEditingLocation] = useState(false);
            const [tempLocationName, setTempLocationName] = useState('');
            const [searchQuery, setSearchQuery] = useState('');
            const [toast, setToast] = useState(null); // { message, type }
            
            // Modal States
            const [showBroadcastModal, setShowBroadcastModal] = useState(false);
            const [broadcastMsg, setBroadcastMsg] = useState('');
            
            // Edit, Note & Profile Modal States
            const [editingStudent, setEditingStudent] = useState(null); 
            const [noteStudent, setNoteStudent] = useState(null); 
            const [viewProfile, setViewProfile] = useState(null);

            // --- Forms State ---
            const [studentForm, setStudentForm] = useState({ 
                name: '', class: '', contact: '', assignedTeacherId: '', note: '' 
            });
            const [teacherForm, setTeacherForm] = useState({ name: '', password: '' });
            const [loginPasscode, setLoginPasscode] = useState('');
            const [loginError, setLoginError] = useState('');
            
            // New Admin Password Change Form
            const [newAdminPasscode, setNewAdminPasscode] = useState('');
            
            // Teacher Login Specifics
            const [selectedTeacherId, setSelectedTeacherId] = useState(null);
            const [teacherLoginPassword, setTeacherLoginPassword] = useState('');

            // --- Auth Initialization ---
            useEffect(() => {
                const initAuth = async () => {
                    try {
                        // This app relies on Anonymous Authentication.
                        // You MUST enable "Anonymous" in Firebase Console > Authentication > Sign-in method
                        await signInAnonymously(auth);
                    } catch (error) {
                        console.error("Auth Failed", error);
                        // Catch the specific restricted operation error
                        if (error.code === 'auth/admin-restricted-operation' || error.code === 'auth/operation-not-allowed') {
                            setAuthError("Configuration Error: 'Anonymous' sign-in is disabled in your Firebase Console.");
                        } else {
                            setAuthError(error.message);
                        }
                        setLoading(false); 
                    }
                };
                initAuth();
                const unsubscribe = onAuthStateChanged(auth, (u) => {
                    if (u) {
                        setUser(u);
                        setLoading(false);
                        setAuthError(null);
                    } else {
                        // If no user and no error yet, wait for initAuth
                    }
                });
                return () => unsubscribe();
            }, []);

            // --- Data Fetching ---
            useEffect(() => {
                if (!user) return;

                const qStudents = query(collection(db, 'artifacts', appId, 'public', 'data', 'students'));
                const unsubStudents = onSnapshot(qStudents, (snap) => {
                    const list = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                    list.sort((a, b) => (a.onBus === b.onBus ? 0 : a.onBus ? 1 : -1) || a.class.localeCompare(b.class));
                    setStudents(list);
                }, (error) => {
                    console.error("Firestore Error (Students)", error);
                    // Often permissions error if auth failed silently or rules are strict
                });

                const qTeachers = query(collection(db, 'artifacts', appId, 'public', 'data', 'teachers'));
                const unsubTeachers = onSnapshot(qTeachers, (snap) => {
                    setTeachers(snap.docs.map(d => ({ id: d.id, ...d.data() })));
                });

                const settingsRef = doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'global');
                const unsubSettings = onSnapshot(settingsRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        setGlobalSettings(data);
                        setTempLocationName(data.locationName || 'School Campus');
                    } else {
                        // Initialize with default admin password '1234' if document doesn't exist
                        setDoc(settingsRef, { 
                            locationName: 'School Campus', 
                            announcement: '', 
                            sos: false,
                            adminPasscode: '1234'
                        });
                    }
                });

                return () => {
                    unsubStudents();
                    unsubTeachers();
                    unsubSettings();
                };
            }, [user]);

            // --- Helpers ---
            const showToast = (message, type = 'success') => {
                setToast({ message, type });
            };

            // --- Auth Actions ---
            const handleAdminLogin = (e) => {
                e.preventDefault();
                // Verify against database stored passcode
                const correctPasscode = globalSettings.adminPasscode || '1234';
                
                if (loginPasscode === correctPasscode) {
                    setRole('admin');
                    setActiveTab('monitor');
                    setLoginError('');
                    setLoginPasscode('');
                    showToast("Welcome back, Admin");
                } else {
                    setLoginError('Incorrect passcode');
                }
            };

            const handleTeacherSelect = (teacherId) => {
                setSelectedTeacherId(teacherId);
                setTeacherLoginPassword('');
                setLoginError('');
            };

            const submitTeacherLogin = (e) => {
                e.preventDefault();
                const teacher = teachers.find(t => t.id === selectedTeacherId);
                // Verify against database stored teacher password
                if (teacher && teacher.password === teacherLoginPassword) {
                    setCurrentTeacherProfile(teacher);
                    setRole('teacher');
                    setActiveTab('monitor');
                    setSelectedTeacherId(null);
                    setTeacherLoginPassword('');
                    setLoginError('');
                    showToast(`Welcome, ${teacher.name}`);
                } else {
                    setLoginError('Incorrect password');
                }
            };

            const logout = () => {
                setRole(null);
                setCurrentTeacherProfile(null);
                setLoginPasscode('');
                setSelectedTeacherId(null);
                setTeacherLoginPassword('');
                setSearchQuery('');
                setLoginError('');
            };

            // --- Feature Actions ---
            
            const handlePrint = () => {
                const missing = students.filter(s => !s.onBus);
                const present = students.filter(s => s.onBus);
                
                const printWindow = window.open('', '', 'height=800,width=1000');
                if (!printWindow) {
                    showToast("Popup blocked. Please allow popups.", "error");
                    return;
                }

                printWindow.document.write('<html><head><title>Excursion Report</title>');
                printWindow.document.write(`
                    <style>
                        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 40px; color: #333; }
                        h1 { color: #1e293b; border-bottom: 3px solid #6366f1; padding-bottom: 10px; margin-bottom: 5px; }
                        .header-meta { color: #64748b; font-size: 0.9rem; margin-bottom: 30px; }
                        .summary-box { 
                            display: flex; gap: 20px; margin-bottom: 30px; 
                            background: #f8fafc; padding: 20px; border-radius: 8px; border: 1px solid #e2e8f0; 
                        }
                        .stat { flex: 1; }
                        .stat-label { font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.05em; color: #64748b; }
                        .stat-value { font-size: 1.5rem; font-weight: bold; color: #0f172a; }
                        
                        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9rem; }
                        th, td { border-bottom: 1px solid #e2e8f0; padding: 12px 8px; text-align: left; }
                        th { background-color: #f1f5f9; font-weight: 600; color: #475569; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.05em; }
                        tr:nth-child(even) { background-color: #f8fafc; }
                        
                        .status-ok { color: #059669; font-weight: bold; background: #ecfdf5; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; }
                        .status-missing { color: #e11d48; font-weight: bold; background: #fff1f2; padding: 4px 8px; border-radius: 4px; font-size: 0.8rem; }
                        
                        .footer { margin-top: 50px; font-size: 0.8rem; color: #94a3b8; text-align: center; border-top: 1px solid #e2e8f0; padding-top: 20px; }
                        
                        @media print {
                        @page { margin: 20px; }
                        body { -webkit-print-color-adjust: exact; }
                        }
                    </style>
                `);
                printWindow.document.write('</head><body>');
                printWindow.document.write(`<h1>Excursion Report</h1>`);
                printWindow.document.write(`<div class="header-meta">Location: <strong>${globalSettings.locationName}</strong> &bull; Generated: ${new Date().toLocaleString()}</div>`);
                printWindow.document.write(`
                    <div class="summary-box">
                        <div class="stat">
                            <div class="stat-label">Total Students</div>
                            <div class="stat-value">${students.length}</div>
                        </div>
                        <div class="stat">
                            <div class="stat-label">On Bus</div>
                            <div class="stat-value" style="color: #059669">${present.length}</div>
                        </div>
                        <div class="stat">
                            <div class="stat-label">Missing</div>
                            <div class="stat-value" style="color: #e11d48">${missing.length}</div>
                        </div>
                    </div>
                `);
                printWindow.document.write('<table><thead><tr><th>Student Name</th><th>Class</th><th>Assigned Teacher</th><th>Contact</th><th>Current Status</th><th>Notes</th></tr></thead><tbody>');
                students.forEach(s => {
                    const tName = teachers.find(t => t.id === s.assignedTeacherId)?.name || 'Unassigned';
                    const statusHtml = s.onBus ? '<span class="status-ok">ON BUS</span>' : '<span class="status-missing">MISSING</span>';
                    printWindow.document.write(`
                        <tr>
                        <td><strong>${s.name}</strong></td>
                        <td>${s.class}</td>
                        <td>${tName}</td>
                        <td>${s.contact || '-'}</td>
                        <td>${statusHtml}</td>
                        <td style="color: #64748b; font-style: italic;">${s.note || ''}</td>
                        </tr>
                    `);
                });
                printWindow.document.write('</tbody></table>');
                printWindow.document.write('<div class="footer">Generated by Excursion Tracker App</div>');
                printWindow.document.write('</body></html>');
                printWindow.document.close();
                printWindow.focus();
                setTimeout(() => {
                    printWindow.print();
                    printWindow.close();
                }, 500);
                showToast("PDF Generation Started");
            };

            const copyReport = () => {
                const missing = students.filter(s => !s.onBus);
                let text = `*Excursion Status Report*\nLocation: ${globalSettings.locationName}\n`;
                text += `Total: ${students.length} | On Bus: ${students.filter(s => s.onBus).length} | Missing: ${missing.length}\n\n`;
                
                if (missing.length > 0) {
                    text += "*MISSING STUDENTS:*\n";
                    missing.forEach(s => {
                        const t = teachers.find(t => t.id === s.assignedTeacherId)?.name || 'Unassigned';
                        text += `- ${s.name} (${s.class}) [Teacher: ${t}]\n`;
                    });
                } else {
                    text += "âœ… All students accounted for.";
                }
                
                const textArea = document.createElement("textarea");
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showToast("Report copied to clipboard");
            };

            const toggleSOS = async () => {
                const newState = !globalSettings.sos;
                if (newState && !confirm("Activate SOS Emergency Mode? This will alert all teachers.")) return;
                try {
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'global'), {
                        sos: newState
                    }, { merge: true });
                } catch(e) { console.error(e); }
            };

            const resetAllStatuses = async () => {
                if (!window.confirm("CAUTION: This will mark ALL students as 'On Bus'. Continue?")) return;
                const batch = writeBatch(db);
                students.forEach(s => {
                    const ref = doc(db, 'artifacts', appId, 'public', 'data', 'students', s.id);
                    batch.update(ref, { onBus: true });
                });
                await batch.commit();
                showToast("All students marked as present on bus");
            };

            // --- Data Mutations ---
            const updateLocationName = async () => {
                if (!tempLocationName.trim()) return;
                try {
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'global'), {
                        locationName: tempLocationName
                    }, { merge: true });
                    setIsEditingLocation(false);
                    showToast("Location updated");
                } catch (e) { console.error(e); }
            };

            const updateAdminPasscode = async (e) => {
                e.preventDefault();
                if (!newAdminPasscode.trim()) return;
                try {
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'global'), {
                        adminPasscode: newAdminPasscode.trim()
                    }, { merge: true });
                    setNewAdminPasscode('');
                    showToast("Admin passcode updated successfully");
                } catch (e) { console.error(e); }
            };

            const sendBroadcast = async () => {
                try {
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'global'), {
                        announcement: broadcastMsg
                    }, { merge: true });
                    setShowBroadcastModal(false);
                    setBroadcastMsg('');
                    showToast("Broadcast sent");
                } catch (e) { console.error(e); }
            };

            const clearBroadcast = async () => {
                try {
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'global'), {
                        announcement: ''
                    }, { merge: true });
                    showToast("Broadcast cleared");
                } catch (e) { console.error(e); }
            };

            const addTeacher = async (e) => {
                e.preventDefault();
                if (!teacherForm.name.trim() || !teacherForm.password.trim()) return;
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'teachers'), {
                    name: teacherForm.name,
                    password: teacherForm.password,
                    createdAt: Date.now()
                });
                setTeacherForm({ name: '', password: '' });
                showToast("Teacher added successfully");
            };

            const addStudent = async (e) => {
                e.preventDefault();
                if (!studentForm.name || !studentForm.class) return;
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'students'), {
                    name: studentForm.name,
                    class: studentForm.class,
                    contact: studentForm.contact,
                    assignedTeacherId: studentForm.assignedTeacherId,
                    note: '',
                    onBus: true,
                    createdAt: Date.now()
                });
                setStudentForm({ name: '', class: '', contact: '', assignedTeacherId: '', note: '' });
                setShowAddModal(false);
                showToast("Student added");
            };

            const updateStudent = async (e) => {
                e.preventDefault();
                if (!editingStudent) return;
                try {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'students', editingStudent.id), {
                        name: editingStudent.name,
                        class: editingStudent.class,
                        contact: editingStudent.contact,
                        assignedTeacherId: editingStudent.assignedTeacherId
                    });
                    setEditingStudent(null);
                    showToast("Student updated");
                } catch (err) { console.error(err); }
            };

            const saveNote = async () => {
                if (!noteStudent) return;
                try {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'students', noteStudent.id), {
                        note: noteStudent.note
                    });
                    setNoteStudent(null);
                    showToast("Note saved");
                } catch (err) { console.error(err); }
            };

            const deleteStudent = async (id) => {
                if (window.confirm("Delete this student permanently?")) {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'students', id));
                    showToast("Student deleted");
                }
            };

            const deleteTeacher = async (id) => {
                if (window.confirm("Delete this teacher?")) {
                    await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'teachers', id));
                    showToast("Teacher deleted");
                }
            };

            const toggleStudentStatus = async (student) => {
                if (role === 'teacher' && student.assignedTeacherId !== currentTeacherProfile?.id) {
                    showToast("You can only mark your own students", "error");
                    return;
                }
                const ref = doc(db, 'artifacts', appId, 'public', 'data', 'students', student.id);
                await updateDoc(ref, { onBus: !student.onBus });
            };

            const markBatch = async (targetState) => {
                const confirmMsg = targetState ? "Mark ALL assigned students as ON BUS?" : "Mark ALL assigned students as OFF BUS?";
                if (!window.confirm(confirmMsg)) return;

                const studentsToUpdate = filteredStudents;
                const promises = studentsToUpdate.map(s => {
                    if (s.onBus !== targetState) {
                        return updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'students', s.id), { onBus: targetState });
                    }
                    return Promise.resolve();
                });
                await Promise.all(promises);
                showToast(targetState ? "Batch marked ON bus" : "Batch marked OFF bus");
            };

            // --- Filtering Logic ---
            let filteredStudents = students;
            if (role === 'teacher' && currentTeacherProfile) {
                filteredStudents = students.filter(s => s.assignedTeacherId === currentTeacherProfile.id);
            }
            if (viewMode === 'missing') {
                filteredStudents = filteredStudents.filter(s => !s.onBus);
            }
            if (searchQuery) {
                filteredStudents = filteredStudents.filter(s => s.name.toLowerCase().includes(searchQuery.toLowerCase()));
            }

            const studentsOnBusCount = filteredStudents.filter(s => s.onBus).length;
            const totalCount = filteredStudents.length;
            const missingCount = totalCount - studentsOnBusCount;
            const allAboard = missingCount === 0 && totalCount > 0;

            const teacherStats = teachers.map(t => {
                const assigned = students.filter(s => s.assignedTeacherId === t.id);
                const missing = assigned.filter(s => !s.onBus).length;
                return { ...t, assignedCount: assigned.length, missingCount: missing };
            });

            // --- UI Components ---
            if (authError) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-rose-50 p-6 font-sans">
                        <div className="bg-white p-8 rounded-2xl shadow-xl max-w-md w-full border border-rose-100">
                            <div className="flex justify-center mb-4">
                                <AlertTriangle className="w-16 h-16 text-rose-500" />
                            </div>
                            <h2 className="text-xl font-bold text-center text-rose-700 mb-2">Configuration Error</h2>
                            <p className="text-center text-slate-600 mb-6">{authError}</p>
                            <div className="bg-slate-50 p-4 rounded-lg border border-slate-200 text-xs text-slate-500">
                                <p className="font-bold mb-1">To fix this in Firebase Console:</p>
                                <ol className="list-decimal pl-4 space-y-1">
                                    <li>Go to <strong>Authentication</strong> &gt; <strong>Sign-in method</strong></li>
                                    <li>Enable the <strong>Anonymous</strong> provider</li>
                                    <li>Save changes</li>
                                </ol>
                            </div>
                            <button onClick={() => window.location.reload()} className="w-full mt-6 py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700">
                                Retry
                            </button>
                        </div>
                    </div>
                );
            }

            if (loading) return <div className="flex h-screen items-center justify-center bg-slate-50"><Loader2 className="animate-spin w-8 h-8 text-indigo-600" /></div>;

            // 1. LOGIN SCREEN
            if (!role) {
                return (
                    <div className="min-h-screen bg-gradient-to-br from-indigo-50 to-blue-100 flex flex-col items-center justify-center p-6 font-sans">
                        {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}
                        
                        <div className="bg-white max-w-sm w-full rounded-3xl shadow-2xl overflow-hidden transform transition-all">
                            <div className="bg-indigo-600 p-8 text-center relative overflow-hidden">
                                <div className="absolute top-0 left-0 w-full h-full bg-white opacity-10 transform -skew-y-6 origin-bottom-right"></div>
                                <Bus className="w-14 h-14 text-white mx-auto mb-3 relative z-10" />
                                <h1 className="text-3xl font-extrabold text-white relative z-10 tracking-tight">Trip Tracker</h1>
                                <p className="text-indigo-200 text-sm relative z-10 mt-1">Safe Excursion Management</p>
                            </div>
                            
                            <div className="p-8 space-y-6">
                                {!selectedTeacherId ? (
                                    <div>
                                        <h2 className="font-bold text-slate-800 mb-4 flex items-center gap-2 text-sm uppercase tracking-wider">
                                            <GraduationCap className="w-5 h-5 text-indigo-500" />
                                            Teacher Login
                                        </h2>
                                        <div className="grid grid-cols-2 gap-3 max-h-48 overflow-y-auto pr-1">
                                            {teachers.length === 0 ? (
                                                <p className="text-xs text-slate-400 col-span-2 italic text-center py-2 bg-slate-50 rounded-lg">No teachers registered yet.</p>
                                            ) : (
                                                teachers.map(t => (
                                                    <button
                                                        key={t.id}
                                                        onClick={() => handleTeacherSelect(t.id)}
                                                        className="px-3 py-3 text-sm bg-slate-50 hover:bg-indigo-50 border border-slate-100 hover:border-indigo-200 text-slate-700 font-medium rounded-xl transition-all active:scale-95 text-left truncate shadow-sm"
                                                    >
                                                        {t.name}
                                                    </button>
                                                ))
                                            )}
                                        </div>
                                    </div>
                                ) : (
                                    <div className="animate-in slide-in-from-right fade-in duration-300">
                                        <button 
                                            onClick={() => { setSelectedTeacherId(null); setLoginError(''); }}
                                            className="mb-4 text-xs font-bold text-slate-400 hover:text-slate-600 flex items-center gap-1"
                                        >
                                            <ArrowLeft className="w-3 h-3" /> Back to List
                                        </button>
                                        <h2 className="font-bold text-slate-800 mb-4 flex items-center gap-2">
                                            <Lock className="w-5 h-5 text-indigo-500" />
                                            Password for {teachers.find(t => t.id === selectedTeacherId)?.name}
                                        </h2>
                                        <form onSubmit={submitTeacherLogin} className="flex flex-col gap-3">
                                            <input
                                                autoFocus
                                                type="password"
                                                placeholder="Enter Password"
                                                className="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:bg-white outline-none transition-all"
                                                value={teacherLoginPassword}
                                                onChange={(e) => setTeacherLoginPassword(e.target.value)}
                                            />
                                            <button 
                                                type="submit"
                                                className="w-full py-3 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 shadow-lg shadow-indigo-200 transition-all active:scale-95"
                                            >
                                                Login
                                            </button>
                                        </form>
                                        {loginError && <p className="text-rose-500 text-xs mt-3 font-medium text-center">{loginError}</p>}
                                    </div>
                                )}

                                {!selectedTeacherId && (
                                    <>
                                        <div className="relative flex py-2 items-center">
                                            <div className="flex-grow border-t border-slate-200"></div>
                                            <span className="flex-shrink-0 mx-4 text-slate-300 text-xs">OR</span>
                                            <div className="flex-grow border-t border-slate-200"></div>
                                        </div>

                                        <div>
                                            <h2 className="font-bold text-slate-800 mb-4 flex items-center gap-2 text-sm uppercase tracking-wider">
                                                <Shield className="w-5 h-5 text-rose-500" />
                                                Admin Access
                                            </h2>
                                            <form onSubmit={handleAdminLogin} className="flex gap-2">
                                                <input
                                                    type="password"
                                                    placeholder="Passcode"
                                                    className="flex-1 px-4 py-2 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-rose-500 focus:bg-white outline-none transition-all"
                                                    value={loginPasscode}
                                                    onChange={(e) => setLoginPasscode(e.target.value)}
                                                />
                                                <button 
                                                    type="submit"
                                                    className="px-6 py-2 bg-rose-500 text-white rounded-xl font-bold hover:bg-rose-600 shadow-lg shadow-rose-200 transition-all active:scale-95"
                                                >
                                                    Go
                                                </button>
                                            </form>
                                            {loginError && <p className="text-rose-500 text-xs mt-2 font-medium">{loginError}</p>}
                                        </div>
                                    </>
                                )}
                            </div>
                        </div>
                    </div>
                );
            }

            // 2. MAIN APP
            return (
                <div className={`min-h-screen font-sans text-slate-900 pb-32 transition-colors duration-500 ${globalSettings.sos ? 'bg-rose-100' : 'bg-slate-100'}`}>
                    
                    {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}

                    {/* SOS FULL SCREEN OVERLAY */}
                    {globalSettings.sos && (
                        <div className="fixed inset-0 z-50 pointer-events-none flex items-center justify-center border-[20px] border-rose-600 animate-pulse bg-rose-500/10">
                        <div className="bg-rose-600 text-white px-8 py-6 rounded-2xl shadow-2xl animate-bounce flex flex-col sm:flex-row items-center gap-6 pointer-events-auto max-w-lg mx-4 text-center sm:text-left">
                            <AlertOctagon className="w-16 h-16 flex-shrink-0" />
                            <div>
                                <h1 className="text-3xl font-extrabold mb-2">EMERGENCY SOS</h1>
                                <p className="font-bold text-rose-100">ALL STUDENTS & TEACHERS RETURN TO BUS IMMEDIATELY</p>
                                {role === 'admin' && (
                                <button onClick={toggleSOS} className="mt-4 bg-white text-rose-600 px-6 py-2 rounded-lg font-bold hover:bg-rose-50 w-full sm:w-auto">
                                    Dismiss Alert
                                </button>
                                )}
                            </div>
                        </div>
                        </div>
                    )}

                    {/* Global Announcement Banner */}
                    {globalSettings.announcement && (
                        <div className="bg-amber-400 text-amber-900 px-4 py-3 text-sm font-bold flex items-center justify-between shadow-md animate-in slide-in-from-top z-40 relative">
                        <div className="flex items-center gap-3">
                            <Megaphone className="w-5 h-5 flex-shrink-0" />
                            <span>{globalSettings.announcement}</span>
                        </div>
                        {role === 'admin' && (
                            <button onClick={clearBroadcast} className="p-1 hover:bg-amber-500 rounded-full">
                            <X className="w-4 h-4" />
                            </button>
                        )}
                        </div>
                    )}

                    {/* Header */}
                    <header className={`${allAboard ? 'bg-gradient-to-r from-emerald-600 to-teal-600' : 'bg-gradient-to-r from-indigo-700 to-purple-800'} text-white shadow-xl sticky top-0 z-30 transition-all duration-500 rounded-b-[2rem] mx-[-1px]`}>
                        <div className="max-w-xl mx-auto px-5 py-4">
                        <div className="flex justify-between items-start mb-4">
                            <div>
                            <div className="flex items-center gap-2 mb-1">
                                {role === 'admin' ? 
                                <span className="bg-white/20 px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider text-white backdrop-blur-sm">Admin Console</span> 
                                : 
                                <span className="bg-white/20 px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider text-white backdrop-blur-sm">Teacher View</span>
                                }
                            </div>
                            <h1 className="font-bold text-xl flex items-center gap-2">
                                {role === 'admin' ? 'Trip Control' : `Hi, ${currentTeacherProfile?.name}`}
                            </h1>
                            </div>
                            <button onClick={logout} className="p-2 bg-white/10 hover:bg-white/20 rounded-full backdrop-blur-sm transition-all active:scale-95">
                            <LogOut className="w-5 h-5 text-white" />
                            </button>
                        </div>

                        {/* Location Card */}
                        <div className="bg-white/10 backdrop-blur-md rounded-2xl p-4 border border-white/10 mb-2 shadow-inner">
                            <div className="flex items-center gap-2 text-indigo-100 text-xs uppercase tracking-wider mb-1 font-semibold">
                            <MapPin className="w-3 h-3" /> 
                            Current Destination
                            </div>
                            
                            {role === 'admin' && isEditingLocation ? (
                            <div className="flex gap-2 mt-2 animate-in fade-in slide-in-from-top-2">
                                <input 
                                autoFocus
                                value={tempLocationName}
                                onChange={(e) => setTempLocationName(e.target.value)}
                                className="flex-1 bg-white text-slate-800 px-3 py-2 rounded-lg text-lg font-bold outline-none shadow-lg"
                                placeholder="Enter location..."
                                />
                                <button 
                                onClick={updateLocationName}
                                className="bg-emerald-500 hover:bg-emerald-400 text-white px-3 py-2 rounded-lg shadow-lg active:scale-95 transition"
                                >
                                <Save className="w-5 h-5" />
                                </button>
                            </div>
                            ) : (
                            <div className="flex justify-between items-center">
                                <h2 className="text-2xl font-bold text-white leading-tight break-words pr-2 drop-shadow-md">
                                {globalSettings.locationName}
                                </h2>
                                {role === 'admin' && (
                                <button 
                                    onClick={() => { setIsEditingLocation(true); setTempLocationName(globalSettings.locationName); }}
                                    className="p-2 bg-white/20 hover:bg-white/30 rounded-full transition active:scale-95 flex-shrink-0"
                                >
                                    <Edit3 className="w-4 h-4 text-white" />
                                </button>
                                )}
                            </div>
                            )}
                        </div>

                        {/* Status Bar */}
                        <div className="flex items-center gap-3 mt-4">
                            <div className="flex-1 bg-black/20 rounded-xl p-3 backdrop-blur-sm flex flex-col items-center justify-center shadow-lg border border-white/5">
                                <span className="text-[10px] uppercase text-white/70 font-bold mb-1">Students On Bus</span>
                                <span className="text-2xl font-bold">{studentsOnBusCount} / {totalCount}</span>
                            </div>
                            
                            <div className={`flex-1 rounded-xl p-3 flex flex-col items-center justify-center transition-all duration-300 shadow-lg ${allAboard ? 'bg-emerald-500/30 border border-emerald-400/50 backdrop-blur-md' : 'bg-rose-500 shadow-rose-900/40 animate-pulse'}`}>
                                {allAboard ? (
                                <>
                                    <CheckCircle2 className="w-5 h-5 text-emerald-100 mb-1"/>
                                    <span className="text-xs font-bold text-emerald-100 uppercase">Ready to Go</span>
                                </>
                                ) : (
                                <>
                                    <span className="text-2xl font-bold text-white">{missingCount}</span>
                                    <span className="text-[10px] font-bold text-white uppercase">Missing</span>
                                </>
                                )}
                            </div>
                        </div>
                        </div>
                    </header>

                    {/* Admin Tabs */}
                    {role === 'admin' && (
                        <div className="bg-white shadow-sm sticky top-[160px] z-20 overflow-x-auto">
                        <div className="max-w-xl mx-auto flex min-w-full">
                            {[
                            { id: 'monitor', label: 'Monitor' },
                            { id: 'students', label: 'Students' },
                            { id: 'teachers', label: 'Teachers' },
                            { id: 'settings', label: 'Settings' }
                            ].map((tab) => (
                            <button 
                                key={tab.id}
                                onClick={() => setActiveTab(tab.id)} 
                                className={`flex-1 py-4 text-xs font-bold uppercase tracking-wider border-b-[3px] transition-colors whitespace-nowrap px-4 ${
                                activeTab === tab.id 
                                    ? 'border-indigo-600 text-indigo-600 bg-indigo-50/50' 
                                    : 'border-transparent text-slate-400 hover:text-slate-600 hover:bg-slate-50'
                                }`}
                            >
                                {tab.label}
                            </button>
                            ))}
                        </div>
                        </div>
                    )}

                    <main className="max-w-xl mx-auto px-4 py-6">
                        
                        {/* --- VIEW: MONITOR --- */}
                        {activeTab === 'monitor' && (
                        <div className="space-y-5 animate-in fade-in duration-500">
                            
                            {/* ADMIN EXTRAS */}
                            {role === 'admin' && (
                            <div className="space-y-4">
                                {/* Search & Actions */}
                                <div className="flex items-center gap-2">
                                <div className="flex-1 bg-white p-2.5 rounded-xl border border-slate-200 shadow-sm flex items-center gap-2 focus-within:ring-2 focus-within:ring-indigo-500/20 transition-all">
                                    <Search className="w-5 h-5 text-slate-400 ml-1" />
                                    <input 
                                    placeholder="Search student..."
                                    className="flex-1 bg-transparent outline-none p-1 text-slate-700 font-medium w-full"
                                    value={searchQuery}
                                    onChange={(e) => setSearchQuery(e.target.value)}
                                    />
                                    {searchQuery && (
                                    <button onClick={() => setSearchQuery('')} className="p-1 hover:bg-slate-100 rounded-full">
                                        <X className="w-4 h-4 text-slate-400" />
                                    </button>
                                    )}
                                </div>
                                <button onClick={() => setShowBroadcastModal(true)} className="p-3.5 bg-indigo-100 text-indigo-600 rounded-xl border border-indigo-200 shadow-sm hover:bg-indigo-200 active:scale-95 transition-all">
                                    <Bell className="w-5 h-5" />
                                </button>
                                </div>

                                {/* Group Status Cards */}
                                <div>
                                <div className="flex justify-between items-center mb-2 px-1">
                                    <h3 className="text-xs font-bold uppercase text-slate-400 tracking-wider">Group Status</h3>
                                </div>
                                
                                <div className="flex gap-3 overflow-x-auto pb-4 pt-1 scrollbar-hide -mx-4 px-4">
                                    {teacherStats.length === 0 ? <p className="text-sm text-slate-400 italic">No groups yet</p> : 
                                    teacherStats.map(stat => (
                                        <div key={stat.id} className={`flex-shrink-0 w-36 p-4 rounded-xl border border-l-[6px] shadow-sm flex flex-col justify-between transition-transform hover:scale-[1.02] ${
                                        stat.missingCount === 0 
                                            ? 'bg-emerald-50 border-emerald-500 border-l-emerald-500' 
                                            : 'bg-white border-slate-200 border-l-rose-500'
                                        }`}>
                                        <div className="text-xs font-bold text-slate-700 truncate mb-3">{stat.name}</div>
                                        <div className="flex items-center gap-2">
                                            {stat.missingCount === 0 ? (
                                            <div className="flex items-center gap-1.5 text-emerald-700 bg-emerald-100/50 px-2 py-1 rounded-lg">
                                                <Check className="w-3 h-3" />
                                                <span className="text-xs font-bold">All OK</span>
                                            </div>
                                            ) : (
                                            <span className="text-xl font-bold text-rose-600 flex items-baseline gap-1">
                                                {stat.missingCount} 
                                                <span className="text-[10px] font-bold text-rose-400 uppercase">Missing</span>
                                            </span>
                                            )}
                                        </div>
                                        </div>
                                    ))
                                    }
                                </div>
                                </div>
                            </div>
                            )}

                            {/* Teacher Search */}
                            {role === 'teacher' && (
                            <div className="bg-white p-2 rounded-xl border border-slate-200 shadow-sm flex items-center gap-2">
                                <Search className="w-5 h-5 text-slate-400 ml-2" />
                                <input 
                                    placeholder="Find in my group..."
                                    className="flex-1 bg-transparent outline-none p-1 text-slate-700 font-medium"
                                    value={searchQuery}
                                    onChange={(e) => setSearchQuery(e.target.value)}
                                />
                            </div>
                            )}

                            {/* Filter/Action Bar */}
                            <div className="flex gap-3 overflow-x-auto pb-1 mt-2">
                            <button 
                                onClick={() => setViewMode(viewMode === 'all' ? 'missing' : 'all')}
                                className={`flex-1 min-w-[140px] py-3 rounded-xl text-sm font-bold shadow-sm border transition-all active:scale-[0.98] flex items-center justify-center gap-2 ${
                                viewMode === 'missing' 
                                    ? 'bg-amber-100 border-amber-200 text-amber-800' 
                                    : 'bg-white border-slate-200 text-slate-600'
                                }`}
                            >
                                <Filter className="w-4 h-4"/> {viewMode === 'missing' ? 'Show All' : 'Missing Only'}
                            </button>
                            
                            <button onClick={() => markBatch(false)} className="px-4 bg-white border border-slate-200 rounded-xl text-rose-500 hover:bg-rose-50 hover:border-rose-200 shadow-sm active:scale-95 transition-all flex items-center gap-2 font-semibold text-xs" title="Everyone Off">
                                <RotateCcw className="w-4 h-4" /> All Off
                            </button>
                            <button onClick={() => markBatch(true)} className="px-4 bg-white border border-slate-200 rounded-xl text-emerald-600 hover:bg-emerald-50 hover:border-emerald-200 shadow-sm active:scale-95 transition-all flex items-center gap-2 font-semibold text-xs" title="Everyone On">
                                <CheckCircle2 className="w-4 h-4" /> All On
                            </button>
                            </div>

                            {/* List */}
                            <div className="space-y-3">
                            {filteredStudents.length === 0 ? (
                                <div className="text-center py-16 opacity-50 flex flex-col items-center">
                                <Users className="w-16 h-16 text-slate-300 mb-3" />
                                <p className="text-slate-400 font-medium">No students match your filter.</p>
                                </div>
                            ) : (
                                filteredStudents.map(student => {
                                const assignedTeacher = teachers.find(t => t.id === student.assignedTeacherId);
                                const isMyStudent = role === 'admin' || (currentTeacherProfile && student.assignedTeacherId === currentTeacherProfile.id);
                                const hasNote = student.note && student.note.trim().length > 0;

                                return (
                                    <div 
                                    key={student.id}
                                    onClick={() => toggleStudentStatus(student)}
                                    className={`
                                        relative overflow-hidden group
                                        flex items-center justify-between p-4 rounded-2xl shadow-sm border-l-[6px] transition-all duration-300 active:scale-[0.98]
                                        ${student.onBus 
                                        ? 'bg-white border-emerald-500' 
                                        : 'bg-white border-rose-500 shadow-rose-100'
                                        }
                                        ${!isMyStudent ? 'opacity-50 grayscale cursor-not-allowed' : 'cursor-pointer hover:shadow-md'}
                                    `}
                                    >
                                    <div className="flex items-center gap-4 relative z-10 flex-1 min-w-0">
                                        <div className={`
                                            w-12 h-12 rounded-2xl flex-shrink-0 flex items-center justify-center font-bold text-lg shadow-inner
                                            ${student.onBus ? 'bg-emerald-50 text-emerald-600' : 'bg-rose-50 text-rose-600'}
                                        `}>
                                        {student.class || "?"}
                                        </div>
                                        <div className="min-w-0">
                                        <h3 
                                            onClick={(e) => {
                                            e.stopPropagation();
                                            setViewProfile(student);
                                            }}
                                            className={`font-bold text-lg truncate hover:underline decoration-2 decoration-indigo-300 cursor-pointer ${student.onBus ? 'text-slate-700' : 'text-slate-900'}`}
                                        >
                                            {student.name}
                                        </h3>
                                        <div className="flex flex-wrap gap-2 mt-1">
                                            {student.contact && (
                                                <a 
                                                href={`tel:${student.contact}`}
                                                onClick={(e) => e.stopPropagation()}
                                                className="text-[10px] bg-slate-100 border border-slate-200 px-2 py-1 rounded-md flex items-center gap-1 hover:bg-indigo-50 hover:text-indigo-600 hover:border-indigo-200 transition-colors text-slate-500 font-medium"
                                                >
                                                <Phone className="w-3 h-3" /> Call
                                                </a>
                                            )}
                                            <button 
                                                onClick={(e) => { e.stopPropagation(); setNoteStudent(student); }}
                                                className={`text-[10px] border px-2 py-1 rounded-md flex items-center gap-1 transition-colors font-medium
                                                ${hasNote 
                                                    ? 'bg-amber-50 border-amber-200 text-amber-700 hover:bg-amber-100' 
                                                    : 'bg-slate-50 border-slate-100 text-slate-400 hover:bg-slate-100'
                                                }`}
                                            >
                                                <StickyNote className="w-3 h-3" /> {hasNote ? 'Note' : '+ Note'}
                                            </button>
                                            
                                            <span className="text-[10px] px-2 py-1 rounded-md bg-slate-50 text-slate-400 flex items-center gap-1 border border-slate-100">
                                                <UserCheck className="w-3 h-3"/> {assignedTeacher?.name || 'Unassigned'}
                                            </span>
                                        </div>
                                        </div>
                                    </div>

                                    <div className="flex items-center gap-3 relative z-10 flex-shrink-0 pl-2">
                                        <div className={`transition-transform duration-300 ${student.onBus ? 'scale-100' : 'scale-110'}`}>
                                        {student.onBus 
                                            ? <CheckCircle2 className="w-8 h-8 text-emerald-400"/> 
                                            : <XCircle className="w-8 h-8 text-rose-500 drop-shadow-sm"/>
                                        }
                                        </div>
                                    </div>
                                    
                                    {!student.onBus && (
                                        <div className="absolute inset-0 bg-rose-50/30 z-0 pointer-events-none"></div>
                                    )}
                                    </div>
                                );
                                })
                            )}
                            </div>
                        </div>
                        )}

                        {/* --- VIEW: SETTINGS (NEW) --- */}
                        {activeTab === 'settings' && role === 'admin' && (
                        <div className="space-y-6 animate-in slide-in-from-right-4 fade-in duration-300">
                            
                            {/* Admin Profile Card */}
                            <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                                <div className="p-4 bg-slate-50 border-b border-slate-200 flex items-center gap-2">
                                <Shield className="w-5 h-5 text-slate-600" />
                                <h3 className="font-bold text-slate-700">Admin Security</h3>
                                </div>
                                <div className="p-6">
                                <form onSubmit={updateAdminPasscode} className="flex gap-2">
                                    <div className="relative flex-1">
                                    <KeyRound className="w-5 h-5 absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" />
                                    <input 
                                        type="text"
                                        placeholder="Set New Admin Passcode"
                                        className="w-full pl-10 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none"
                                        value={newAdminPasscode}
                                        onChange={(e) => setNewAdminPasscode(e.target.value)}
                                    />
                                    </div>
                                    <button 
                                    type="submit"
                                    className="px-6 py-2 bg-indigo-600 text-white rounded-xl font-bold hover:bg-indigo-700 shadow-md transition-all active:scale-95 whitespace-nowrap"
                                    >
                                    Update
                                    </button>
                                </form>
                                <p className="text-xs text-slate-400 mt-2 ml-2">Current passcode: {globalSettings.adminPasscode}</p>
                                </div>
                            </div>

                            {/* Data Management Card */}
                            <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                                <div className="p-4 bg-slate-50 border-b border-slate-200 flex items-center gap-2">
                                <FileSpreadsheet className="w-5 h-5 text-slate-600" />
                                <h3 className="font-bold text-slate-700">Reports & Data</h3>
                                </div>
                                <div className="p-6 grid gap-4">
                                <button 
                                    onClick={handlePrint}
                                    className="flex items-center justify-between p-4 bg-emerald-50 border border-emerald-100 rounded-xl hover:bg-emerald-100 transition-colors group"
                                >
                                    <div className="text-left">
                                    <div className="font-bold text-emerald-900">Print/Save PDF Report</div>
                                    <div className="text-xs text-emerald-600 mt-1">Generates a printable list for PDF</div>
                                    </div>
                                    <Printer className="w-6 h-6 text-emerald-600 group-hover:scale-110 transition-transform" />
                                </button>

                                <button 
                                    onClick={copyReport}
                                    className="flex items-center justify-between p-4 bg-indigo-50 border border-indigo-100 rounded-xl hover:bg-indigo-100 transition-colors group"
                                >
                                    <div className="text-left">
                                    <div className="font-bold text-indigo-900">Copy Summary to Clipboard</div>
                                    <div className="text-xs text-indigo-600 mt-1">Perfect for WhatsApp/SMS updates</div>
                                    </div>
                                    <Clipboard className="w-6 h-6 text-indigo-600 group-hover:scale-110 transition-transform" />
                                </button>
                                </div>
                            </div>

                            {/* Emergency Zone */}
                            <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                                <div className="p-4 bg-slate-50 border-b border-slate-200 flex items-center gap-2">
                                <SettingsIcon className="w-5 h-5 text-slate-600" />
                                <h3 className="font-bold text-slate-700">System Controls</h3>
                                </div>
                                <div className="p-6 space-y-4">
                                <div className="flex items-center justify-between p-4 bg-rose-50 border border-rose-100 rounded-xl">
                                    <div>
                                        <div className="font-bold text-rose-900 flex items-center gap-2">
                                        <AlertOctagon className="w-5 h-5" /> Emergency SOS
                                        </div>
                                        <div className="text-xs text-rose-600 mt-1 max-w-[200px]">Triggers full-screen alert for all teachers immediately.</div>
                                    </div>
                                    <button 
                                        onClick={toggleSOS}
                                        className={`px-4 py-2 rounded-lg font-bold text-sm transition-all shadow-md ${
                                        globalSettings.sos 
                                            ? 'bg-rose-600 text-white animate-pulse' 
                                            : 'bg-white text-rose-600 border border-rose-200 hover:bg-rose-100'
                                        }`}
                                    >
                                        {globalSettings.sos ? 'DEACTIVATE' : 'ACTIVATE'}
                                    </button>
                                </div>

                                <div className="flex items-center justify-between p-4 bg-slate-50 border border-slate-200 rounded-xl opacity-80 hover:opacity-100 transition-opacity">
                                    <div>
                                        <div className="font-bold text-slate-700 flex items-center gap-2">
                                        <RefreshCw className="w-5 h-5" /> Reset Trip
                                        </div>
                                        <div className="text-xs text-slate-500 mt-1">Mark everyone as "On Bus" to start fresh.</div>
                                    </div>
                                    <button 
                                        onClick={resetAllStatuses}
                                        className="px-4 py-2 bg-white text-slate-600 border border-slate-300 rounded-lg font-bold text-sm hover:bg-slate-200 shadow-sm"
                                    >
                                        Reset All
                                    </button>
                                </div>
                                </div>
                            </div>
                        </div>
                        )}

                        {/* --- VIEW: MANAGE STUDENTS --- */}
                        {activeTab === 'students' && (
                        <div className="space-y-6 animate-in slide-in-from-right-4 fade-in duration-300">
                            <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                            <h3 className="font-bold text-lg mb-4 flex items-center gap-2 text-slate-700">
                                <UserPlus className="w-5 h-5 text-indigo-600"/> Add Student
                            </h3>
                            <form onSubmit={addStudent} className="space-y-4">
                                <input 
                                required
                                placeholder="Student Name"
                                className="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:bg-white outline-none transition-all"
                                value={studentForm.name}
                                onChange={e => setStudentForm({...studentForm, name: e.target.value})}
                                />
                                <div className="grid grid-cols-2 gap-3">
                                <input 
                                    required
                                    placeholder="Class (e.g. 10-A)"
                                    className="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:bg-white outline-none transition-all"
                                    value={studentForm.class}
                                    onChange={e => setStudentForm({...studentForm, class: e.target.value})}
                                />
                                <input 
                                    type="tel"
                                    placeholder="Contact Number"
                                    className="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:bg-white outline-none transition-all"
                                    value={studentForm.contact}
                                    onChange={e => setStudentForm({...studentForm, contact: e.target.value})}
                                />
                                </div>
                                <div className="relative">
                                <select 
                                    className="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:bg-white outline-none appearance-none transition-all"
                                    value={studentForm.assignedTeacherId}
                                    onChange={e => setStudentForm({...studentForm, assignedTeacherId: e.target.value})}
                                >
                                    <option value="">-- Assign Teacher --</option>
                                    {teachers.map(t => <option key={t.id} value={t.id}>{t.name}</option>)}
                                </select>
                                <div className="absolute right-4 top-1/2 -translate-y-1/2 pointer-events-none text-slate-400">â–¼</div>
                                </div>
                                <button type="submit" className="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold hover:bg-indigo-700 shadow-lg shadow-indigo-200 active:scale-95 transition-all">
                                Add Student
                                </button>
                            </form>
                            </div>

                            <div className="space-y-2">
                            <h3 className="font-bold text-slate-400 text-xs uppercase tracking-wider ml-1">Student Registry ({students.length})</h3>
                            {students.map(s => {
                                const tName = teachers.find(t => t.id === s.assignedTeacherId)?.name || 'Unassigned';
                                return (
                                <div key={s.id} className="bg-white p-4 rounded-xl border border-slate-100 shadow-sm flex justify-between items-center group hover:border-indigo-200 transition-colors">
                                    <div>
                                    <div className="flex items-baseline gap-2">
                                        <span className="font-bold text-slate-800">{s.name}</span>
                                        <span className="text-xs font-bold text-indigo-600 bg-indigo-50 px-1.5 rounded">{s.class}</span>
                                    </div>
                                    <div className="text-xs text-slate-500 mt-1 flex items-center gap-1">
                                        Assigned to: <span className="text-slate-700 font-medium">{tName}</span>
                                    </div>
                                    </div>
                                    <div className="flex items-center gap-2 opacity-60 group-hover:opacity-100 transition-opacity">
                                    <button onClick={() => setEditingStudent(s)} className="text-slate-400 hover:text-indigo-600 p-2 transition-colors">
                                        <Edit3 className="w-4 h-4" />
                                    </button>
                                    <button onClick={() => deleteStudent(s.id)} className="text-slate-400 hover:text-rose-500 p-2 transition-colors">
                                        <Trash2 className="w-4 h-4" />
                                    </button>
                                    </div>
                                </div>
                                )
                            })}
                            </div>
                        </div>
                        )}

                        {/* --- VIEW: MANAGE TEACHERS --- */}
                        {activeTab === 'teachers' && (
                        <div className="space-y-6 animate-in slide-in-from-right-4 fade-in duration-300">
                            <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                            <h3 className="font-bold text-lg mb-4 flex items-center gap-2 text-slate-700">
                                <GraduationCap className="w-5 h-5 text-emerald-600"/> Add Teacher Profile
                            </h3>
                            <form onSubmit={addTeacher} className="flex flex-col gap-3">
                                <div className="flex gap-3">
                                <input 
                                    required
                                    placeholder="Teacher Name"
                                    className="flex-1 px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:bg-white outline-none transition-all"
                                    value={teacherForm.name}
                                    onChange={e => setTeacherForm({...teacherForm, name: e.target.value})}
                                />
                                <input 
                                    required
                                    type="text"
                                    placeholder="Set Password"
                                    className="w-1/3 px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-emerald-500 focus:bg-white outline-none transition-all"
                                    value={teacherForm.password}
                                    onChange={e => setTeacherForm({...teacherForm, password: e.target.value})}
                                />
                                </div>
                                <button type="submit" className="w-full px-6 py-3 bg-emerald-500 text-white rounded-xl font-bold hover:bg-emerald-600 shadow-lg shadow-emerald-200 active:scale-95 transition-all">
                                Create Teacher Account
                                </button>
                            </form>
                            </div>

                            <div className="space-y-2">
                            <h3 className="font-bold text-slate-400 text-xs uppercase tracking-wider ml-1">Registered Faculty</h3>
                            {teachers.map(t => (
                                <div key={t.id} className="bg-white p-4 rounded-xl border border-slate-100 shadow-sm flex justify-between items-center group hover:border-emerald-200 transition-colors">
                                <div className="flex items-center gap-3">
                                    <div className="w-10 h-10 rounded-full bg-gradient-to-br from-indigo-100 to-purple-100 flex items-center justify-center font-bold text-indigo-700 shadow-inner">
                                    {t.name.charAt(0)}
                                    </div>
                                    <div>
                                    <div className="font-bold text-slate-700">{t.name}</div>
                                    <div className="text-xs text-slate-400 flex items-center gap-1 group-hover:text-emerald-600 transition-colors">
                                        <Key className="w-3 h-3" /> Password: {t.password}
                                    </div>
                                    </div>
                                </div>
                                <button onClick={() => deleteTeacher(t.id)} className="text-slate-300 hover:text-rose-500 p-2 transition-colors">
                                    <Trash2 className="w-4 h-4" />
                                </button>
                                </div>
                            ))}
                            </div>
                        </div>
                        )}

                    </main>

                    {/* --- MODALS --- */}
                    
                    {/* 1. Broadcast Modal */}
                    {showBroadcastModal && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-6">
                        <div className="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl animate-in zoom-in-95 duration-200">
                            <h2 className="text-xl font-bold mb-4 flex items-center gap-2 text-slate-800">
                            <Megaphone className="w-6 h-6 text-amber-500" />
                            Broadcast Message
                            </h2>
                            <p className="text-sm text-slate-500 mb-4">This message will appear on everyone's screen immediately.</p>
                            <textarea 
                            autoFocus
                            className="w-full p-3 border border-slate-300 rounded-xl mb-4 focus:ring-2 focus:ring-amber-500 outline-none resize-none h-32"
                            placeholder="e.g. Everyone return to the bus! Lunch is starting..."
                            value={broadcastMsg}
                            onChange={(e) => setBroadcastMsg(e.target.value)}
                            />
                            <div className="flex gap-3">
                            <button 
                                onClick={() => setShowBroadcastModal(false)}
                                className="flex-1 py-3 bg-slate-100 font-bold rounded-xl text-slate-600 hover:bg-slate-200"
                            >
                                Cancel
                            </button>
                            <button 
                                onClick={sendBroadcast}
                                className="flex-1 py-3 bg-amber-500 hover:bg-amber-600 font-bold rounded-xl text-white shadow-lg shadow-amber-200"
                            >
                                Send Now
                            </button>
                            </div>
                        </div>
                        </div>
                    )}

                    {/* 2. Edit Student Modal */}
                    {editingStudent && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-6">
                        <div className="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl animate-in zoom-in-95 duration-200">
                            <h2 className="text-xl font-bold mb-4 flex items-center gap-2 text-slate-800">
                            <Edit3 className="w-6 h-6 text-indigo-600" />
                            Edit Student
                            </h2>
                            <form onSubmit={updateStudent} className="space-y-4">
                            <input 
                                className="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none"
                                value={editingStudent.name}
                                onChange={e => setEditingStudent({...editingStudent, name: e.target.value})}
                                placeholder="Name"
                            />
                            <div className="grid grid-cols-2 gap-3">
                                <input 
                                className="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none"
                                value={editingStudent.class}
                                onChange={e => setEditingStudent({...editingStudent, class: e.target.value})}
                                placeholder="Class"
                                />
                                <input 
                                className="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none"
                                value={editingStudent.contact}
                                onChange={e => setEditingStudent({...editingStudent, contact: e.target.value})}
                                placeholder="Contact"
                                />
                            </div>
                            <select 
                                className="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none"
                                value={editingStudent.assignedTeacherId}
                                onChange={e => setEditingStudent({...editingStudent, assignedTeacherId: e.target.value})}
                            >
                                <option value="">-- Assign Teacher --</option>
                                {teachers.map(t => <option key={t.id} value={t.id}>{t.name}</option>)}
                            </select>
                            <div className="flex gap-3 pt-2">
                                <button 
                                type="button" 
                                onClick={() => setEditingStudent(null)}
                                className="flex-1 py-3 bg-slate-100 font-bold rounded-xl text-slate-600"
                                >
                                Cancel
                                </button>
                                <button 
                                type="submit"
                                className="flex-1 py-3 bg-indigo-600 text-white font-bold rounded-xl shadow-lg"
                                >
                                Save
                                </button>
                            </div>
                            </form>
                        </div>
                        </div>
                    )}

                    {/* 3. Note Modal */}
                    {noteStudent && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-6">
                        <div className="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl animate-in zoom-in-95 duration-200">
                            <h2 className="text-xl font-bold mb-2 flex items-center gap-2 text-slate-800">
                            <StickyNote className="w-6 h-6 text-amber-500" />
                            Student Notes
                            </h2>
                            <p className="text-sm text-slate-500 mb-4">Add medical alerts or important info for {noteStudent.name}.</p>
                            <textarea 
                            autoFocus
                            className="w-full p-3 border border-slate-300 rounded-xl mb-4 focus:ring-2 focus:ring-amber-500 outline-none resize-none h-32 bg-amber-50 text-slate-800"
                            placeholder="e.g. Asthmatic, Parents picking up at 4pm..."
                            value={noteStudent.note || ''}
                            onChange={(e) => setNoteStudent({...noteStudent, note: e.target.value})}
                            />
                            <div className="flex gap-3">
                            <button 
                                onClick={() => setNoteStudent(null)}
                                className="flex-1 py-3 bg-slate-100 font-bold rounded-xl text-slate-600 hover:bg-slate-200"
                            >
                                Close
                            </button>
                            <button 
                                onClick={saveNote}
                                className="flex-1 py-3 bg-amber-500 hover:bg-amber-600 font-bold rounded-xl text-white shadow-lg shadow-amber-200"
                            >
                                Save Note
                            </button>
                            </div>
                        </div>
                        </div>
                    )}

                    {/* 4. Profile View Modal */}
                    {viewProfile && (
                        <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm p-6">
                            <div className="bg-white w-full max-w-sm rounded-2xl p-6 shadow-2xl animate-in zoom-in-95 duration-200 relative">
                                <button 
                                    onClick={() => setViewProfile(null)}
                                    className="absolute top-4 right-4 p-2 bg-slate-100 hover:bg-slate-200 rounded-full transition-colors"
                                >
                                    <X className="w-4 h-4 text-slate-500" />
                                </button>
                                
                                <div className="text-center mb-6">
                                    <div className="w-20 h-20 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center text-3xl font-bold mx-auto mb-4">
                                        {viewProfile.name.charAt(0)}
                                    </div>
                                    <h2 className="text-2xl font-bold text-slate-800">{viewProfile.name}</h2>
                                    <p className="text-slate-500 font-medium">Student Profile</p>
                                </div>

                                <div className="space-y-4">
                                    <div className="bg-slate-50 p-4 rounded-xl border border-slate-100 flex justify-between items-center">
                                        <div>
                                            <label className="text-xs font-bold text-slate-400 uppercase tracking-wider block mb-1">Class / Grade</label>
                                            <span className="text-lg font-bold text-slate-800">{viewProfile.class}</span>
                                        </div>
                                        <div className="p-2 bg-indigo-50 text-indigo-600 rounded-lg">
                                            <GraduationCap className="w-5 h-5" />
                                        </div>
                                    </div>

                                    <div className="bg-slate-50 p-4 rounded-xl border border-slate-100">
                                        <label className="text-xs font-bold text-slate-400 uppercase tracking-wider block mb-1">Contact Number</label>
                                        {viewProfile.contact ? (
                                            <div className="flex items-center justify-between">
                                                <span className="text-lg font-bold text-slate-800">{viewProfile.contact}</span>
                                                <a 
                                                    href={`tel:${viewProfile.contact}`}
                                                    className="p-2 bg-emerald-100 text-emerald-600 rounded-lg hover:bg-emerald-200 transition-colors"
                                                >
                                                    <Phone className="w-5 h-5" />
                                                </a>
                                            </div>
                                        ) : (
                                            <span className="text-slate-400 italic">No contact provided</span>
                                        )}
                                    </div>

                                    <div className="bg-slate-50 p-4 rounded-xl border border-slate-100">
                                        <label className="text-xs font-bold text-slate-400 uppercase tracking-wider block mb-1">Assigned Teacher</label>
                                        <div className="font-medium text-slate-700">
                                            {teachers.find(t => t.id === viewProfile.assignedTeacherId)?.name || 'Unassigned'}
                                        </div>
                                    </div>

                                    {viewProfile.note && (
                                        <div className="bg-amber-50 p-4 rounded-xl border border-amber-100">
                                            <label className="text-xs font-bold text-amber-400 uppercase tracking-wider block mb-1">Notes</label>
                                            <p className="text-amber-800 text-sm">{viewProfile.note}</p>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}

                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
